<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Documents - RBS</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" href="./Images/RBS Favicon.ico" type="image/x-icon" />
    <style>
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .header h1 {
        color: #333;
        margin: 0;
      }

      .btn {
        background: #ff2c3c;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: #e02635;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: #ff2c3c;
        margin-bottom: 10px;
      }

      .stat-label {
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        overflow: hidden;
      }

      .section-header {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 1px solid #e1e5e9;
      }

      .section-title {
        margin: 0;
        color: #333;
        font-size: 1.2em;
      }

      .document-list {
        padding: 0;
      }

      .document-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e1e5e9;
        transition: background 0.3s ease;
      }

      .document-item:hover {
        background: #f8f9fa;
      }

      .document-item:last-child {
        border-bottom: none;
      }

      .document-info {
        flex: 1;
      }

      .document-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .document-meta {
        color: #666;
        font-size: 14px;
      }

      .document-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .status-expired {
        background: #f8d7da;
        color: #721c24;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 20px;
      }

      .back-link {
        color: #666;
        text-decoration: none;
        margin-bottom: 20px;
        display: inline-block;
      }

      .back-link:hover {
        color: #ff2c3c;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .message {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px 10px;
        }

        .header {
          flex-direction: column;
          text-align: center;
        }

        .document-item {
          flex-direction: column;
          gap: 15px;
          align-items: stretch;
        }

        .document-actions {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html">
        <div class="logo">
          <img
            id="logo"
            src="./Images/RBS Logo main.svg"
            alt="RBS Logo. It's a box that's red"
          />
        </div>
      </a>
      <div class="burger">
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
      </div>

      <div id="webNav">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ‚ñº</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>

          <br />
          <br />
          <br />
        </div>
      </div>
      <div class="dropdown-content">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ‚ñº</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>
        </div>
      </div>
      <div id="shadow"></div>
    </nav>

    <a href="index.html" class="back-link">‚Üê Back to Home</a>

    <div class="container">
      <div class="header">
        <h1>My Documents</h1>
        <a href="custom-document-signing.html" class="btn"
          >+ Send New Document</a
        >
      </div>

      <div id="messageContainer"></div>

      <!-- Statistics -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="sentCount">-</div>
          <div class="stat-label">Documents Sent</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="receivedCount">-</div>
          <div class="stat-label">Documents to Sign</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="completedCount">-</div>
          <div class="stat-label">Completed</div>
        </div>
      </div>

      <!-- Documents I've Sent -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">üì§ Documents I've Sent</h2>
        </div>
        <div class="document-list" id="sentDocuments">
          <div class="loading">Loading your sent documents...</div>
        </div>
      </div>

      <!-- Documents I Need to Sign -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">‚úçÔ∏è Documents I Need to Sign</h2>
        </div>
        <div class="document-list" id="receivedDocuments">
          <div class="loading">Loading documents to sign...</div>
        </div>
      </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="config/firebase-config.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-functions.js";

      // Initialize Firebase
      if (!window.firebaseConfig) {
        console.error("Firebase configuration not loaded!");
      }

      const app = initializeApp(window.firebaseConfig);
      const auth = getAuth(app);
      const functions = getFunctions(app);

      let currentUser = null;

      // Check authentication
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          showMessage("Please sign in to view your documents.", "error");
          setTimeout(() => {
            window.location.href = "signin.html";
          }, 2000);
        } else {
          currentUser = user;
          loadDocuments();
        }
      });

      async function loadDocuments() {
        try {
          const getUserSubmissions = httpsCallable(
            functions,
            "getUserDocumentSubmissions"
          );
          const result = await getUserSubmissions();

          if (result.data.success) {
            displayDocuments(result.data.submissions);
          } else {
            throw new Error(result.data.error || "Failed to load documents");
          }
        } catch (error) {
          console.error("Error loading documents:", error);
          showMessage(`Error loading documents: ${error.message}`, "error");
          showEmptyState("sentDocuments");
          showEmptyState("receivedDocuments");
        }
      }

      function displayDocuments(submissions) {
        const sentDocs = [];
        const receivedDocs = [];
        let completedCount = 0;

        submissions.forEach((doc) => {
          if (doc.isCreator) {
            sentDocs.push(doc);
          } else {
            receivedDocs.push(doc);
          }
          if (doc.status === "completed") {
            completedCount++;
          }
        });

        // Update statistics
        document.getElementById("sentCount").textContent = sentDocs.length;
        document.getElementById("receivedCount").textContent =
          receivedDocs.length;
        document.getElementById("completedCount").textContent = completedCount;

        // Display documents
        displayDocumentList("sentDocuments", sentDocs, true);
        displayDocumentList("receivedDocuments", receivedDocs, false);
      }

      function displayDocumentList(containerId, documents, isSent) {
        const container = document.getElementById(containerId);

        if (documents.length === 0) {
          showEmptyState(containerId, isSent);
          return;
        }

        container.innerHTML = documents
          .map(
            (doc) => `
          <div class="document-item">
            <div class="document-info">
              <div class="document-title">${doc.templateName}</div>
              <div class="document-meta">
                ${
                  isSent
                    ? `Sent to ${doc.signers?.length || 0} signer(s)`
                    : "Waiting for your signature"
                } ‚Ä¢ 
                ${new Date(doc.createdAt).toLocaleDateString()}
              </div>
            </div>
            <div class="document-actions">
              <span class="status-badge status-${doc.status}">${
              doc.status
            }</span>
              ${
                doc.status === "completed"
                  ? `<button class="btn btn-secondary" onclick="downloadDocument('${doc.id}')">Download</button>`
                  : `<button class="btn" onclick="viewDocument('${doc.id}')">
                     ${isSent ? "View" : "Sign"}
                   </button>`
              }
            </div>
          </div>
        `
          )
          .join("");
      }

      function showEmptyState(containerId, isSent = null) {
        const container = document.getElementById(containerId);
        const message =
          isSent === true
            ? "You haven't sent any documents yet."
            : isSent === false
            ? "No documents waiting for your signature."
            : "No documents found.";

        const actionButton =
          isSent === true
            ? '<a href="custom-document-signing.html" class="btn" style="margin-top: 20px;">Send Your First Document</a>'
            : "";

        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìÑ</div>
            <div>${message}</div>
            ${actionButton}
          </div>
        `;
      }

      // Global functions for buttons
      window.viewDocument = function (documentId) {
        // For now, just show an alert. In a real implementation,
        // this would open a view/sign page
        window.open(`view-document.html?id=${documentId}`, "_blank");
      };

      window.downloadDocument = function (documentId) {
        // For now, just show an alert. In a real implementation,
        // this would download the completed document
        showMessage("Download functionality coming soon!", "info");
      };

      function showMessage(message, type = "info") {
        const container = document.getElementById("messageContainer");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = message;
        container.appendChild(messageDiv);

        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }
    </script>

    <!-- Navigation Scripts -->
    <script src="./scripts/script.js"></script>
    <script src="./scripts/footer.js"></script>
    <script src="./scripts/grid.js"></script>
  </body>
</html>
