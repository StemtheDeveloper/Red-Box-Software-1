<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom Document Signing - RBS</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" href="./Images/RBS Favicon.ico" type="image/x-icon" />
    <style>
      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .header h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .header p {
        color: #666;
        font-size: 18px;
      }

      .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
      }

      .tabs {
        display: flex;
        border-bottom: 2px solid #eee;
        margin-bottom: 30px;
      }

      .tab {
        padding: 12px 24px;
        cursor: pointer;
        background: none;
        border: none;
        font-size: 16px;
        color: #666;
        transition: all 0.3s ease;
      }

      .tab.active {
        color: #007bff;
        border-bottom: 2px solid #007bff;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #007bff;
      }

      .file-upload {
        border: 2px dashed #ddd;
        border-radius: 6px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #f9f9f9;
      }

      .file-upload:hover {
        border-color: #007bff;
        background-color: #f0f8ff;
      }

      .file-upload.dragover {
        border-color: #007bff;
        background-color: #e6f3ff;
      }

      .file-upload-icon {
        font-size: 48px;
        color: #ddd;
        margin-bottom: 16px;
      }

      .file-info {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        display: none;
      }

      .signers-list {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 20px;
        background: #f9f9f9;
      }

      .signer-item {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr auto;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
      }

      .signer-item:last-child {
        margin-bottom: 0;
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn:hover {
        background: #0056b3;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .btn-danger {
        background: #dc3545;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .btn-success {
        background: #28a745;
      }

      .btn-success:hover {
        background: #218838;
      }

      .message {
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .message.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .document-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        transition: box-shadow 0.3s ease;
      }

      .document-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .document-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
      }

      .document-meta {
        font-size: 14px;
        color: #666;
        margin-bottom: 12px;
      }

      .document-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-partial {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px 10px;
        }

        .signer-item {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .tabs {
          flex-direction: column;
        }

        .tab {
          text-align: left;
          border-bottom: 1px solid #eee;
        }
      }

      .auth-section {
        text-align: center;
        padding: 60px 20px;
      }

      .sign-in-btn {
        display: inline-block;
        padding: 15px 30px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav>
      <a href="index.html">
        <div class="logo">
          <img
            id="logo"
            src="./Images/RBS Logo main.svg"
            alt="RBS Logo. It's a box that's red"
          />
        </div>
      </a>
      <div class="burger">
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
      </div>

      <div id="webNav">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More â–¼</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>

          <br />
          <br />
          <br />
        </div>
      </div>
      <div class="dropdown-content">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More â–¼</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>
        </div>
      </div>
      <div id="shadow"></div>
    </nav>

    <div class="container">
      <div class="header">
        <h1>ðŸ“„ Custom Document Signing</h1>
        <p>
          Upload, share, and collect signatures on your important documents
          securely
        </p>
      </div>

      <!-- Authentication Section -->
      <div id="authSection" class="auth-section" style="display: none">
        <div class="card">
          <div class="message error">
            Please log in to access document signing features.
          </div>
          <a href="signin.html" class="sign-in-btn">Sign In</a>
          <a href="simple-dashboard.html" class="btn btn-secondary"
            >Back to Dashboard</a
          >
        </div>
      </div>

      <!-- Main Content -->
      <div id="mainContent" style="display: none">
        <div class="card">
          <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">
              ðŸ“¤ Upload Document
            </button>
            <button class="tab" onclick="switchTab('documents')">
              ðŸ“‹ My Documents
            </button>
          </div>

          <!-- Upload Document Tab -->
          <div id="uploadTab" class="tab-content active">
            <form id="uploadForm">
              <div class="form-group">
                <label for="documentTitle">Document Title *</label>
                <input
                  type="text"
                  id="documentTitle"
                  name="title"
                  placeholder="e.g. Employment Contract, NDA, Agreement"
                  required
                />
              </div>

              <div class="form-group">
                <label for="documentDescription">Description (Optional)</label>
                <textarea
                  id="documentDescription"
                  name="description"
                  rows="3"
                  placeholder="Brief description of the document..."
                ></textarea>
              </div>

              <div class="form-group">
                <label>PDF Document *</label>
                <div class="file-upload" id="fileUpload">
                  <div class="file-upload-icon">ðŸ“„</div>
                  <p>
                    <strong>Click to select</strong> or drag and drop your PDF
                    here
                  </p>
                  <p style="color: #666; font-size: 14px">
                    Maximum file size: 10MB
                  </p>
                </div>
                <input
                  type="file"
                  id="fileInput"
                  accept=".pdf"
                  style="display: none"
                />
                <div id="fileInfo" class="file-info"></div>
              </div>

              <div class="form-group">
                <label>Signers *</label>
                <div class="signers-list" id="signersList">
                  <div class="signer-item">
                    <input
                      type="text"
                      placeholder="Full Name"
                      class="signer-name"
                      required
                    />
                    <input
                      type="email"
                      placeholder="Email Address"
                      class="signer-email"
                      required
                    />
                    <input
                      type="text"
                      placeholder="Role (optional)"
                      class="signer-role"
                    />
                    <button
                      type="button"
                      onclick="removeSigner(this)"
                      class="btn btn-danger"
                    >
                      Remove
                    </button>
                  </div>
                </div>
                <button
                  type="button"
                  onclick="addSigner()"
                  class="btn btn-secondary"
                  style="margin-top: 15px"
                >
                  + Add Another Signer
                </button>
              </div>

              <button type="submit" class="btn btn-success">
                ðŸ“¤ Upload & Send for Signing
              </button>
            </form>

            <div id="uploadResult"></div>
          </div>

          <!-- Documents List Tab -->
          <div id="documentsTab" class="tab-content">
            <div class="loading" id="documentsLoading">
              <div class="spinner"></div>
              <p>Loading your documents...</p>
            </div>
            <div id="documentsContainer"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="config/firebase-config.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFunctions } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";
      import { getStorage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const functions = getFunctions(app, "us-central1"); // Specify region
      const storage = getStorage(app);
      const firestore = getFirestore(app);

      // Make Firebase available globally
      window.firebase = {
        app,
        auth,
        functions,
        storage,
        firestore,
      };

      // Initialize custom document client
      // Wait for the CustomDocumentClient to be available
      const initClient = () => {
        if (window.CustomDocumentClient) {
          window.customDocumentClient = new CustomDocumentClient(
            window.firebase
          );
        } else {
          setTimeout(initClient, 100);
        }
      };
      initClient();

      // Authentication handling
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          document.getElementById("authSection").style.display = "none";
          document.getElementById("mainContent").style.display = "block";

          // Update user info in nav (if elements exist)
          const userNameElement = document.getElementById("userName");
          const userAvatarElement = document.getElementById("userAvatar");

          if (userNameElement) {
            userNameElement.textContent = user.displayName || user.email;
          }
          if (userAvatarElement) {
            userAvatarElement.src =
              user.photoURL || "Images/default-avatar.png";
          }

          // Load user documents
          loadUserDocuments();
        } else {
          document.getElementById("authSection").style.display = "block";
          document.getElementById("mainContent").style.display = "none";
        }
      });

      // Global sign out function
      window.handleSignOut = async () => {
        try {
          await signOut(auth);
          window.location.href = "signin.html";
        } catch (error) {
          console.error("Error signing out:", error);
        }
      };
    </script>

    <!-- Custom Document Client -->
    <script src="scripts/custom-document-client.js"></script>

    <!-- Page Scripts -->
    <script>
      let selectedFile = null;

      // File upload handling
      document.addEventListener("DOMContentLoaded", function () {
        const fileUpload = document.getElementById("fileUpload");
        const fileInput = document.getElementById("fileInput");
        const fileInfo = document.getElementById("fileInfo");

        fileUpload.addEventListener("click", () => fileInput.click());

        fileInput.addEventListener("change", handleFileSelect);

        // Drag and drop
        fileUpload.addEventListener("dragover", (e) => {
          e.preventDefault();
          fileUpload.classList.add("dragover");
        });

        fileUpload.addEventListener("dragleave", () => {
          fileUpload.classList.remove("dragover");
        });

        fileUpload.addEventListener("drop", (e) => {
          e.preventDefault();
          fileUpload.classList.remove("dragover");
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFileSelect({ target: { files } });
          }
        });

        // Form submission
        document
          .getElementById("uploadForm")
          .addEventListener("submit", handleFormSubmit);
      });

      function handleFileSelect(event) {
        const file = event.target.files[0];
        const fileInfo = document.getElementById("fileInfo");

        if (!file) {
          selectedFile = null;
          fileInfo.style.display = "none";
          return;
        }

        if (file.type !== "application/pdf") {
          window.customDocumentClient.showMessage(
            "Please select a PDF file.",
            "error"
          );
          return;
        }

        if (file.size > 10 * 1024 * 1024) {
          window.customDocumentClient.showMessage(
            "File size must be under 10MB.",
            "error"
          );
          return;
        }

        selectedFile = file;
        fileInfo.innerHTML = `
          <strong>Selected File:</strong> ${file.name}<br>
          <strong>Size:</strong> ${window.customDocumentClient.formatFileSize(
            file.size
          )}<br>
          <strong>Type:</strong> ${file.type}
        `;
        fileInfo.style.display = "block";
      }

      async function handleFormSubmit(event) {
        event.preventDefault();

        // Check if customDocumentClient is available
        if (!window.customDocumentClient) {
          document.getElementById("uploadResult").innerHTML = `
            <div class="message error">
              <strong>Error:</strong> Document client not initialized. Please refresh the page and try again.
            </div>
          `;
          return;
        }

        if (!selectedFile) {
          window.customDocumentClient.showMessage(
            "Please select a PDF file.",
            "error"
          );
          return;
        }

        const title = document.getElementById("documentTitle").value.trim();
        const description = document
          .getElementById("documentDescription")
          .value.trim();

        if (!title) {
          window.customDocumentClient.showMessage(
            "Please provide a document title.",
            "error"
          );
          return;
        }

        // Collect signers
        const signers = [];
        document.querySelectorAll(".signer-item").forEach((item) => {
          const name = item.querySelector(".signer-name").value.trim();
          const email = item.querySelector(".signer-email").value.trim();
          const role = item.querySelector(".signer-role").value.trim();

          if (name && email) {
            if (!window.customDocumentClient.isValidEmail(email)) {
              throw new Error(`Invalid email address: ${email}`);
            }
            signers.push({
              name: name,
              email: email,
              role: role || "Signer",
            });
          }
        });

        if (signers.length === 0) {
          window.customDocumentClient.showMessage(
            "Please add at least one signer.",
            "error"
          );
          return;
        }

        // Show loading
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = "Uploading...";

        const resultDiv = document.getElementById("uploadResult");
        resultDiv.innerHTML =
          '<div class="message info">Uploading document and sending invitations...</div>';

        try {
          const result = await window.customDocumentClient.uploadDocument({
            file: selectedFile,
            title: title,
            description: description,
            signers: signers,
          });

          resultDiv.innerHTML = `
            <div class="message success">
              <strong>Document uploaded successfully!</strong><br>
              <strong>Document ID:</strong> ${result.documentId}<br>
              <strong>Status:</strong> ${result.status}<br>
              Email invitations have been sent to all signers.
            </div>
          `;

          // Reset form
          document.getElementById("uploadForm").reset();
          selectedFile = null;
          document.getElementById("fileInfo").style.display = "none";

          // Refresh documents list
          loadUserDocuments();
        } catch (error) {
          console.error("Upload error:", error);
          resultDiv.innerHTML = `
            <div class="message error">
              <strong>Upload failed:</strong> ${error.message}
            </div>
          `;
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }

      function addSigner() {
        const signersList = document.getElementById("signersList");
        const signerItem = document.createElement("div");
        signerItem.className = "signer-item";
        signerItem.innerHTML = `
          <input type="text" placeholder="Full Name" class="signer-name" required>
          <input type="email" placeholder="Email Address" class="signer-email" required>
          <input type="text" placeholder="Role (optional)" class="signer-role">
          <button type="button" onclick="removeSigner(this)" class="btn btn-danger">Remove</button>
        `;
        signersList.appendChild(signerItem);
      }

      function removeSigner(button) {
        const signersList = document.getElementById("signersList");
        if (signersList.children.length > 1) {
          button.parentElement.remove();
        } else {
          window.customDocumentClient.showMessage(
            "At least one signer is required.",
            "warning"
          );
        }
      }

      function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(tabName + "Tab").classList.add("active");
        event.target.classList.add("active");

        // Load documents if documents tab is selected
        if (tabName === "documents") {
          loadUserDocuments();
        }
      }

      async function loadUserDocuments() {
        // Check if customDocumentClient is available
        if (!window.customDocumentClient) {
          const containerDiv = document.getElementById("documentsContainer");
          containerDiv.innerHTML = `
            <div class="message error">
              <strong>Error:</strong> Document client not initialized. Please refresh the page and try again.
            </div>
          `;
          return;
        }

        const loadingDiv = document.getElementById("documentsLoading");
        const containerDiv = document.getElementById("documentsContainer");

        loadingDiv.style.display = "block";
        containerDiv.innerHTML = "";

        try {
          const result = await window.customDocumentClient.getUserDocuments({
            limit: 50,
          });

          loadingDiv.style.display = "none";

          if (result.documents.length === 0) {
            containerDiv.innerHTML = `
              <div class="message info">
                <strong>No documents found.</strong><br>
                Upload your first document to get started with electronic signatures.
              </div>
            `;
            return;
          }

          const documentsGrid = document.createElement("div");
          documentsGrid.className = "documents-grid";

          result.documents.forEach((doc) => {
            const documentCard = document.createElement("div");
            documentCard.className = "document-card";
            documentCard.innerHTML = `
              <div class="document-title">${doc.title}</div>
              <div class="document-meta">
                Created: ${new Date(
                  doc.createdAt.seconds * 1000
                ).toLocaleDateString()}<br>
                Role: ${doc.role}<br>
                Signers: ${doc.completedSigners}/${doc.signersCount}
              </div>
              <div class="document-status status-${doc.status}">${
              doc.status
            }</div>
              <div style="margin-top: 15px;">
                <button onclick="viewDocument('${
                  doc.id
                }')" class="btn" style="font-size: 14px; padding: 8px 16px;">
                  View Document
                </button>
              </div>
            `;
            documentsGrid.appendChild(documentCard);
          });

          containerDiv.appendChild(documentsGrid);
        } catch (error) {
          console.error("Error loading documents:", error);
          loadingDiv.style.display = "none";
          containerDiv.innerHTML = `
            <div class="message error">
              <strong>Error loading documents:</strong> ${error.message}
            </div>
          `;
        }
      }

      function viewDocument(documentId) {
        window.open(`custom-view-document.html?id=${documentId}`, "_blank");
      }
    </script>
  </body>
</html>
