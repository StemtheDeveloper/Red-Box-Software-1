<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document Dashboard - RBS</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" href="./Images/RBS Favicon.ico" type="image/x-icon" />
    <style>
      .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      .dashboard-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 40px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .dashboard-title {
        color: #333;
        margin: 0;
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .btn {
        background: #ff2c3c;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: #e02635;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: #ff2c3c;
        margin-bottom: 10px;
      }

      .stat-label {
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .documents-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
      }

      .section-header {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 1px solid #e1e5e9;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .section-title {
        margin: 0;
        color: #333;
        font-size: 1.4em;
      }

      .documents-list {
        padding: 0;
      }

      .document-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
      }

      .document-item:hover {
        background-color: #f8f9fa;
      }

      .document-item:last-child {
        border-bottom: none;
      }

      .document-info {
        flex: 1;
      }

      .document-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 1.1em;
      }

      .document-meta {
        color: #666;
        font-size: 0.9em;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
      }

      .document-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .status-expired {
        background: #f8d7da;
        color: #721c24;
      }

      .action-link {
        color: #ff2c3c;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9em;
      }

      .action-link:hover {
        text-decoration: underline;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state-icon {
        font-size: 4em;
        margin-bottom: 20px;
        color: #ddd;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #ff2c3c;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .message {
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .back-link {
        display: inline-block;
        color: #ff2c3c;
        text-decoration: none;
        margin-bottom: 20px;
        font-weight: 600;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      @media (max-width: 768px) {
        .dashboard-container {
          padding: 20px 10px;
        }

        .dashboard-header {
          flex-direction: column;
          align-items: stretch;
          text-align: center;
        }

        .document-item {
          flex-direction: column;
          align-items: stretch;
          gap: 15px;
        }

        .document-actions {
          justify-content: center;
        }

        .document-meta {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html">
        <div class="logo">
          <img
            id="logo"
            src="./Images/RBS Logo main.svg"
            alt="RBS Logo. It's a box that's red"
          />
        </div>
      </a>
      <div class="burger">
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
      </div>

      <div id="webNav">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ‚ñº</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>

          <br />
          <br />
          <br />
        </div>
      </div>
      <div class="dropdown-content">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ‚ñº</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>
        </div>
      </div>
      <div id="shadow"></div>
    </nav>

    <div class="dashboard-container">
      <a href="index.html" class="back-link">‚Üê Back to Home</a>

      <div class="dashboard-header">
        <h1 class="dashboard-title">üìä Document Dashboard</h1>
        <div class="action-buttons">
          <a href="document-signing.html" class="btn">üìÑ Send New Document</a>
          <button class="btn btn-secondary" onclick="refreshDashboard()">
            üîÑ Refresh
          </button>
        </div>
      </div>

      <div id="messageContainer"></div>

      <!-- Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalSent">-</div>
          <div class="stat-label">Documents Sent</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalReceived">-</div>
          <div class="stat-label">Documents Received</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingSigning">-</div>
          <div class="stat-label">Pending Signatures</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="completedDocs">-</div>
          <div class="stat-label">Completed Documents</div>
        </div>
      </div>

      <!-- Documents You've Sent -->
      <div class="documents-section">
        <div class="section-header">
          <h2 class="section-title">üì§ Documents You've Sent</h2>
        </div>
        <div class="documents-list" id="sentDocuments">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading your sent documents...</p>
          </div>
        </div>
      </div>

      <!-- Documents You Need to Sign -->
      <div class="documents-section">
        <div class="section-header">
          <h2 class="section-title">‚úçÔ∏è Documents You Need to Sign</h2>
        </div>
        <div class="documents-list" id="receivedDocuments">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading documents to sign...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="config/firebase-config.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-functions.js";

      // Initialize Firebase
      if (!window.firebaseConfig) {
        console.error("Firebase configuration not loaded!");
        return;
      }

      const app = initializeApp(window.firebaseConfig);
      const auth = getAuth(app);
      const functions = getFunctions(app);

      // Check authentication
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href =
            "signin.html?redirect=" +
            encodeURIComponent(window.location.pathname);
          return;
        }

        // Load dashboard data
        loadDashboardData();
      });

      // Sign out function
      window.handleSignOut = async function () {
        try {
          await signOut(auth);
          window.location.href = "index.html";
        } catch (error) {
          console.error("Sign out error:", error);
        }
      };

      // Refresh dashboard
      window.refreshDashboard = function () {
        loadDashboardData();
      };

      // Load dashboard data
      async function loadDashboardData() {
        try {
          const getUserSubmissions = httpsCallable(
            functions,
            "getUserDocumentSubmissions"
          );
          const result = await getUserSubmissions();

          if (result.data.success) {
            const submissions = result.data.submissions;
            displayDashboardData(submissions);
          } else {
            throw new Error(
              result.data.error || "Failed to load dashboard data"
            );
          }
        } catch (error) {
          console.error("Error loading dashboard data:", error);
          showMessage(
            "Error loading dashboard data: " + error.message,
            "error"
          );
          showEmptyState();
        }
      }

      function displayDashboardData(submissions) {
        const currentUserEmail = auth.currentUser?.email;

        // Separate sent and received documents
        const sentDocs = submissions.filter((sub) => sub.isCreator);
        const receivedDocs = submissions.filter((sub) => !sub.isCreator);

        // Calculate statistics
        const totalSent = sentDocs.length;
        const totalReceived = receivedDocs.length;
        const pendingSigning = submissions.filter(
          (sub) => sub.status === "pending"
        ).length;
        const completedDocs = submissions.filter(
          (sub) => sub.status === "completed"
        ).length;

        // Update stats
        document.getElementById("totalSent").textContent = totalSent;
        document.getElementById("totalReceived").textContent = totalReceived;
        document.getElementById("pendingSigning").textContent = pendingSigning;
        document.getElementById("completedDocs").textContent = completedDocs;

        // Display documents
        displayDocuments("sentDocuments", sentDocs, true);
        displayDocuments("receivedDocuments", receivedDocs, false);
      }

      function displayDocuments(containerId, documents, isSent) {
        const container = document.getElementById(containerId);

        if (documents.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">${isSent ? "üì§" : "‚úçÔ∏è"}</div>
              <h3>No ${isSent ? "sent" : "received"} documents</h3>
              <p>${
                isSent
                  ? "Documents you send will appear here"
                  : "Documents you need to sign will appear here"
              }</p>
            </div>
          `;
          return;
        }

        container.innerHTML = documents
          .map((doc) => createDocumentItem(doc, isSent))
          .join("");
      }

      function createDocumentItem(doc, isSent) {
        const createdDate = doc.createdAt
          ? new Date(doc.createdAt.seconds * 1000).toLocaleDateString()
          : "Unknown";
        const statusClass = `status-${doc.status}`;

        let signerInfo = "";
        if (doc.signers && doc.signers.length > 0) {
          if (doc.signers.length === 1) {
            signerInfo = `Signer: ${doc.signers[0].name}`;
          } else {
            signerInfo = `${doc.signers.length} signers`;
          }
        }

        const actions = isSent
          ? `<a href="#" onclick="viewDocument('${doc.id}')" class="action-link">View Details</a>`
          : `<a href="#" onclick="signDocument('${doc.id}')" class="action-link">Sign Document</a>`;

        return `
          <div class="document-item">
            <div class="document-info">
              <div class="document-title">${doc.templateName}</div>
              <div class="document-meta">
                <span>üìÖ ${createdDate}</span>
                ${signerInfo ? `<span>üë• ${signerInfo}</span>` : ""}
                ${!isSent ? `<span>üìß From: ${doc.createdByEmail}</span>` : ""}
              </div>
            </div>
            <div class="document-actions">
              <span class="status-badge ${statusClass}">${doc.status}</span>
              ${actions}
            </div>
          </div>
        `;
      }

      function showEmptyState() {
        document.getElementById("sentDocuments").innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìÑ</div>
            <h3>Unable to load documents</h3>
            <p>Please try refreshing the page</p>
          </div>
        `;

        document.getElementById("receivedDocuments").innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìÑ</div>
            <h3>Unable to load documents</h3>
            <p>Please try refreshing the page</p>
          </div>
        `;
      }

      // Document actions
      window.viewDocument = function (documentId) {
        // For now, just show an alert. In a full implementation, this would open a document viewer
        alert(
          `View document ${documentId} - This feature would show document details and signing status`
        );
      };

      window.signDocument = function (documentId) {
        // For now, just show an alert. In a full implementation, this would open the signing interface
        alert(
          `Sign document ${documentId} - This feature would open the signing interface`
        );
      };

      function showMessage(message, type = "info") {
        const messageContainer = document.getElementById("messageContainer");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = message;

        messageContainer.innerHTML = "";
        messageContainer.appendChild(messageDiv);

        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }
    </script>

    <!-- Navigation Scripts -->
    <script src="./scripts/script.js"></script>
    <script src="./scripts/footer.js"></script>
    <script src="./scripts/grid.js"></script>
  </body>
</html>
