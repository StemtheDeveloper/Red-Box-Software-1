<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test PDF Viewer - RBS</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .instructions {
        background: #e7f3ff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§ª PDF Viewer Test Page</h1>

      <div class="instructions">
        <h3>ğŸ“‹ How to Test:</h3>
        <ol>
          <li>
            First, upload a document using the
            <a href="custom-document-signing.html" target="_blank"
              >Document Signing</a
            >
            page
          </li>
          <li>Copy the document ID from the URL or dashboard</li>
          <li>Paste it below and click "Test PDF Viewer"</li>
          <li>If you have an access token, you can test that too</li>
        </ol>
      </div>

      <div class="test-section">
        <h3>ğŸ”— PDF Viewer Test</h3>
        <div>
          <label for="documentId">Document ID:</label><br />
          <input
            type="text"
            id="documentId"
            placeholder="Enter document ID"
            style="width: 100%; padding: 8px; margin: 5px 0"
          />
        </div>
        <div>
          <label for="accessToken">Access Token (optional):</label><br />
          <input
            type="text"
            id="accessToken"
            placeholder="Enter access token (if testing unauthenticated access)"
            style="width: 100%; padding: 8px; margin: 5px 0"
          />
        </div>
        <button onclick="testPdfViewer()">ğŸ” Test PDF Viewer</button>
        <button onclick="testWithToken()">ğŸ”‘ Test with Token</button>
      </div>

      <div class="test-section">
        <h3>ğŸ”§ Firebase Connection Test</h3>
        <button onclick="testFirebaseConnection()">Test Firebase</button>
        <button onclick="testCustomClient()">Test Custom Client</button>
        <div id="connectionStatus"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ“Š Test Results</h3>
        <div id="testResults"></div>
      </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="config/firebase-config.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFunctions } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";
      import { getStorage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const functions = getFunctions(app, "us-central1");
      const storage = getStorage(app);
      const firestore = getFirestore(app);

      // Make Firebase available globally
      window.firebase = { app, auth, functions, storage, firestore };

      // Initialize custom document client
      const initClient = () => {
        if (window.CustomDocumentClient) {
          window.customDocumentClient = new CustomDocumentClient(
            window.firebase
          );
          console.log("Custom Document Client initialized");
        } else {
          setTimeout(initClient, 100);
        }
      };
      initClient();

      // Monitor auth state
      onAuthStateChanged(auth, (user) => {
        window.currentUser = user;
        const status = document.getElementById("connectionStatus");
        if (status) {
          status.innerHTML = user
            ? `<div class="status success">âœ… Signed in as: ${user.email}</div>`
            : `<div class="status info">â„¹ï¸ Not signed in (can still test with access tokens)</div>`;
        }
      });
    </script>

    <!-- Custom Document Client -->
    <script src="scripts/custom-document-client.js"></script>

    <script>
      function addResult(message, type = "info") {
        const results = document.getElementById("testResults");
        const timestamp = new Date().toLocaleTimeString();
        results.innerHTML += `<div class="status ${type}">[${timestamp}] ${message}</div>`;
        results.scrollTop = results.scrollHeight;
      }

      function testFirebaseConnection() {
        addResult("Testing Firebase connection...");

        if (window.firebase && window.firebase.auth) {
          addResult("âœ… Firebase initialized successfully", "success");
          addResult(
            `Current user: ${
              window.currentUser ? window.currentUser.email : "Not signed in"
            }`
          );
        } else {
          addResult("âŒ Firebase not initialized", "error");
        }
      }

      function testCustomClient() {
        addResult("Testing Custom Document Client...");

        if (window.customDocumentClient) {
          addResult("âœ… Custom Document Client initialized", "success");
        } else {
          addResult("âŒ Custom Document Client not available", "error");
        }
      }

      async function testPdfViewer() {
        const documentId = document.getElementById("documentId").value.trim();

        if (!documentId) {
          addResult("âŒ Please enter a document ID", "error");
          return;
        }

        if (!window.customDocumentClient) {
          addResult("âŒ Custom Document Client not available", "error");
          return;
        }

        addResult(`ğŸ” Testing PDF viewer for document: ${documentId}`);

        try {
          // First test getting document metadata
          addResult("ğŸ“„ Getting document metadata...");
          const docResult = await window.customDocumentClient.getDocument(
            documentId
          );
          addResult(
            `âœ… Document found: ${docResult.document.title}`,
            "success"
          );

          // Then test getting PDF data
          addResult("ğŸ“¥ Getting PDF data...");
          const pdfResult = await window.customDocumentClient.getDocumentPdf(
            documentId
          );
          addResult(
            `âœ… PDF loaded successfully (${Math.round(
              (pdfResult.pdfData.length * 0.75) / 1024
            )} KB)`,
            "success"
          );

          // Open the actual viewer
          window.open(`custom-view-document.html?id=${documentId}`, "_blank");
          addResult("ğŸš€ Opened PDF viewer in new tab", "success");
        } catch (error) {
          addResult(`âŒ Error: ${error.message}`, "error");
          console.error("PDF Viewer Test Error:", error);
        }
      }

      async function testWithToken() {
        const documentId = document.getElementById("documentId").value.trim();
        const accessToken = document.getElementById("accessToken").value.trim();

        if (!documentId) {
          addResult("âŒ Please enter a document ID", "error");
          return;
        }

        if (!accessToken) {
          addResult("âŒ Please enter an access token", "error");
          return;
        }

        addResult(`ğŸ”‘ Testing with access token for document: ${documentId}`);

        try {
          const docResult = await window.customDocumentClient.getDocument(
            documentId,
            accessToken
          );
          addResult(
            `âœ… Document accessible with token: ${docResult.document.title}`,
            "success"
          );

          const pdfResult = await window.customDocumentClient.getDocumentPdf(
            documentId,
            accessToken
          );
          addResult(
            `âœ… PDF accessible with token (${Math.round(
              (pdfResult.pdfData.length * 0.75) / 1024
            )} KB)`,
            "success"
          );

          // Open the viewer with token
          window.open(
            `custom-view-document.html?id=${documentId}&token=${accessToken}`,
            "_blank"
          );
          addResult("ğŸš€ Opened PDF viewer with token in new tab", "success");
        } catch (error) {
          addResult(`âŒ Token test error: ${error.message}`, "error");
          console.error("Token Test Error:", error);
        }
      }

      // Auto-test connection when page loads
      window.addEventListener("load", () => {
        setTimeout(() => {
          testFirebaseConnection();
          testCustomClient();
        }, 1000);
      });
    </script>
  </body>
</html>
