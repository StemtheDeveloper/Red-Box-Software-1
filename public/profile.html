<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - Red Box Software</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" href="./Images/RBS Favicon.ico" type="image/x-icon" />
    <style>
      .profile-container {
        max-width: 800px;
        margin: 100px auto 50px;
        padding: 0 20px;
      }

      .profile-header {
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        text-align: center;
      }

      .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin: 0 auto 20px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 48px;
        font-weight: bold;
        position: relative;
        overflow: hidden;
      }

      .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
      }

      .profile-name {
        font-size: 28px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
      }

      .profile-email {
        color: #666;
        font-size: 16px;
        margin-bottom: 20px;
      }

      .profile-status {
        display: inline-block;
        padding: 8px 16px;
        background: #d4edda;
        color: #155724;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
      }

      .profile-tabs {
        display: flex;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        overflow: hidden;
      }

      .tab-button {
        flex: 1;
        padding: 15px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        color: #666;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
      }

      .tab-button.active {
        color: #007bff;
        border-bottom-color: #007bff;
        background: #f8f9fa;
      }

      .tab-content {
        display: none;
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .tab-content.active {
        display: block;
      }

      .form-section {
        margin-bottom: 30px;
      }

      .form-section h3 {
        font-size: 20px;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .btn {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
      }

      .btn:hover {
        background: linear-gradient(135deg, #0056b3, #004085);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
      }

      .btn-danger:hover {
        background: linear-gradient(135deg, #c82333, #a71e2a);
      }

      .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .setting-item:last-child {
        border-bottom: none;
      }

      .setting-info h4 {
        margin: 0 0 5px 0;
        color: #333;
        font-size: 16px;
      }

      .setting-info p {
        margin: 0;
        color: #666;
        font-size: 14px;
      }

      .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
        background: #ccc;
        border-radius: 15px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .toggle-switch.active {
        background: #007bff;
      }

      .toggle-switch::before {
        content: "";
        position: absolute;
        top: 3px;
        left: 3px;
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 50%;
        transition: transform 0.3s ease;
      }

      .toggle-switch.active::before {
        transform: translateX(30px);
      }

      .message {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .message.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .back-link {
        position: absolute;
        top: 20px;
        left: 20px;
        color: #007bff;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .loading.show {
        display: flex;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .password-requirements {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .requirement {
        display: flex;
        align-items: center;
        gap: 5px;
        margin: 2px 0;
      }

      .requirement.valid {
        color: #28a745;
      }

      .requirement.invalid {
        color: #dc3545;
      }

      @media (max-width: 768px) {
        .profile-container {
          margin: 50px auto 20px;
          padding: 0 15px;
        }

        .profile-header,
        .tab-content {
          padding: 20px;
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .profile-tabs {
          flex-direction: column;
        }

        .tab-button {
          border-bottom: 1px solid #e1e5e9;
          border-right: none;
        }

        .tab-button.active {
          border-bottom-color: #e1e5e9;
          border-left: 3px solid #007bff;
        }

        .back-link {
          position: static;
          display: inline-block;
          margin-bottom: 20px;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html">
        <div class="logo">
          <img
            id="logo"
            src="./Images/RBS Logo main.svg"
            alt="RBS Logo. It's a box that's red"
          />
        </div>
      </a>
      <div class="burger">
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
      </div>

      <div id="webNav">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ▼</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <a href="profile.html" style="display: none"><li>Profile</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>

          <br />
          <br />
          <br />
        </div>
      </div>
      <div class="dropdown-content">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ▼</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <a href="profile.html" style="display: none"><li>Profile</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>
        </div>
      </div>
      <div id="shadow"></div>
    </nav>

    <a href="index.html" class="back-link"> ← Back to Home </a>

    <div class="loading" id="loading">
      <div class="spinner"></div>
    </div>

    <div class="profile-container">
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar">
          <span id="avatarInitials">U</span>
        </div>
        <div class="profile-name" id="profileName">Loading...</div>
        <div class="profile-email" id="profileEmail">Loading...</div>
        <div class="profile-status" id="profileStatus">Account Active</div>
      </div>

      <!-- Profile Tabs -->
      <div class="profile-tabs">
        <button class="tab-button active" onclick="switchTab('personal')">
          Personal Info
        </button>
        <button class="tab-button" onclick="switchTab('security')">
          Security
        </button>
        <button class="tab-button" onclick="switchTab('preferences')">
          Preferences
        </button>
        <button class="tab-button" onclick="switchTab('account')">
          Account
        </button>
      </div>

      <!-- Personal Information Tab -->
      <div id="personal-tab" class="tab-content active">
        <div id="personalMessageContainer"></div>

        <form id="personalInfoForm">
          <div class="form-section">
            <h3>Personal Information</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" />
              </div>
              <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone" />
              </div>
              <div class="form-group">
                <label for="company">Company</label>
                <input type="text" id="company" name="company" />
              </div>
            </div>
            <div class="form-group">
              <label for="bio">Bio</label>
              <textarea
                id="bio"
                name="bio"
                placeholder="Tell us about yourself..."
              ></textarea>
            </div>
          </div>

          <div class="form-section">
            <h3>Address</h3>
            <div class="form-group">
              <label for="address">Street Address</label>
              <input type="text" id="address" name="address" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="city">City</label>
                <input type="text" id="city" name="city" />
              </div>
              <div class="form-group">
                <label for="state">State/Province</label>
                <input type="text" id="state" name="state" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="zipCode">ZIP/Postal Code</label>
                <input type="text" id="zipCode" name="zipCode" />
              </div>
              <div class="form-group">
                <label for="country">Country</label>
                <select id="country" name="country">
                  <option value="">Select Country</option>
                  <option value="US">United States</option>
                  <option value="CA">Canada</option>
                  <option value="UK">United Kingdom</option>
                  <option value="AU">Australia</option>
                  <option value="DE">Germany</option>
                  <option value="FR">France</option>
                  <option value="JP">Japan</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
            </div>
          </div>

          <button type="submit" class="btn" id="savePersonalBtn">
            Save Changes
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            onclick="resetPersonalForm()"
          >
            Reset
          </button>
        </form>
      </div>

      <!-- Security Tab -->
      <div id="security-tab" class="tab-content">
        <div id="securityMessageContainer"></div>

        <div class="form-section">
          <h3>Change Password</h3>
          <form id="changePasswordForm">
            <div class="form-group">
              <label for="currentPassword">Current Password</label>
              <input
                type="password"
                id="currentPassword"
                name="currentPassword"
                required
              />
            </div>
            <div class="form-group">
              <label for="newPassword">New Password</label>
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                required
              />
              <div class="password-requirements">
                <div class="requirement" id="lengthReq">
                  <span>•</span> At least 8 characters
                </div>
                <div class="requirement" id="upperReq">
                  <span>•</span> One uppercase letter
                </div>
                <div class="requirement" id="lowerReq">
                  <span>•</span> One lowercase letter
                </div>
                <div class="requirement" id="numberReq">
                  <span>•</span> One number
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm New Password</label>
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                required
              />
            </div>
            <button type="submit" class="btn" id="changePasswordBtn">
              Change Password
            </button>
          </form>
        </div>

        <div class="form-section">
          <h3>Two-Factor Authentication</h3>
          <div class="setting-item">
            <div class="setting-info">
              <h4>SMS Authentication</h4>
              <p>Receive verification codes via SMS</p>
            </div>
            <div
              class="toggle-switch"
              id="smsToggle"
              onclick="toggleSetting('sms')"
            ></div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Email Authentication</h4>
              <p>Receive verification codes via email</p>
            </div>
            <div
              class="toggle-switch active"
              id="emailToggle"
              onclick="toggleSetting('email')"
            ></div>
          </div>
        </div>

        <div class="form-section">
          <h3>Account Security</h3>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Login Notifications</h4>
              <p>Get notified when your account is accessed</p>
            </div>
            <div
              class="toggle-switch active"
              id="loginNotifyToggle"
              onclick="toggleSetting('loginNotify')"
            ></div>
          </div>
        </div>
      </div>

      <!-- Preferences Tab -->
      <div id="preferences-tab" class="tab-content">
        <div id="preferencesMessageContainer"></div>

        <div class="form-section">
          <h3>Display Preferences</h3>
          <div class="form-group">
            <label for="theme">Theme</label>
            <select id="theme" name="theme">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
              <option value="auto">Auto (System)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="language">Language</label>
            <select id="language" name="language">
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="ja">Japanese</option>
            </select>
          </div>
          <div class="form-group">
            <label for="timezone">Timezone</label>
            <select id="timezone" name="timezone">
              <option value="UTC">UTC</option>
              <option value="America/New_York">Eastern Time</option>
              <option value="America/Chicago">Central Time</option>
              <option value="America/Denver">Mountain Time</option>
              <option value="America/Los_Angeles">Pacific Time</option>
              <option value="Europe/London">London</option>
              <option value="Europe/Paris">Paris</option>
              <option value="Asia/Tokyo">Tokyo</option>
            </select>
          </div>
        </div>

        <div class="form-section">
          <h3>Notification Preferences</h3>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Email Notifications</h4>
              <p>Receive updates and announcements via email</p>
            </div>
            <div
              class="toggle-switch active"
              id="emailNotifToggle"
              onclick="toggleSetting('emailNotif')"
            ></div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Marketing Emails</h4>
              <p>Receive promotional content and offers</p>
            </div>
            <div
              class="toggle-switch"
              id="marketingToggle"
              onclick="toggleSetting('marketing')"
            ></div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Document Reminders</h4>
              <p>Get reminders about pending documents</p>
            </div>
            <div
              class="toggle-switch active"
              id="docRemindersToggle"
              onclick="toggleSetting('docReminders')"
            ></div>
          </div>
        </div>

        <button type="button" class="btn" onclick="savePreferences()">
          Save Preferences
        </button>
      </div>

      <!-- Account Tab -->
      <div id="account-tab" class="tab-content">
        <div id="accountMessageContainer"></div>

        <div class="form-section">
          <h3>Account Information</h3>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Account Created</h4>
              <p id="accountCreated">Loading...</p>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Last Sign In</h4>
              <p id="lastSignIn">Loading...</p>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Email Verified</h4>
              <p id="emailVerified">Loading...</p>
            </div>
            <button
              class="btn btn-secondary"
              id="verifyEmailBtn"
              onclick="sendEmailVerification()"
              style="display: none"
            >
              Verify Email
            </button>
          </div>
        </div>

        <div class="form-section">
          <h3>Data Management</h3>
          <button
            type="button"
            class="btn btn-secondary"
            onclick="downloadUserData()"
          >
            Download My Data
          </button>
        </div>

        <div class="form-section">
          <h3>Danger Zone</h3>
          <div
            class="setting-item"
            style="
              border: 2px solid #dc3545;
              border-radius: 8px;
              padding: 20px;
              background: #fff5f5;
            "
          >
            <div class="setting-info">
              <h4 style="color: #dc3545">Delete Account</h4>
              <p>
                Permanently delete your account and all associated data. This
                action cannot be undone.
              </p>
            </div>
            <button class="btn btn-danger" onclick="showDeleteConfirmation()">
              Delete Account
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="loading">
      <div
        style="
          background: white;
          padding: 40px;
          border-radius: 15px;
          max-width: 500px;
          text-align: center;
        "
      >
        <h3 style="color: #dc3545; margin-bottom: 20px">⚠️ Delete Account</h3>
        <p style="margin-bottom: 20px">
          Are you sure you want to delete your account? This action cannot be
          undone and will permanently remove all your data.
        </p>
        <div style="margin-bottom: 20px">
          <input
            type="password"
            id="deletePassword"
            placeholder="Enter your password to confirm"
            style="
              width: 100%;
              padding: 12px;
              border: 2px solid #dc3545;
              border-radius: 8px;
              margin-bottom: 10px;
            "
          />
          <input
            type="text"
            id="deleteConfirmation"
            placeholder="Type 'DELETE' to confirm"
            style="
              width: 100%;
              padding: 12px;
              border: 2px solid #dc3545;
              border-radius: 8px;
            "
          />
        </div>
        <button
          class="btn btn-danger"
          id="confirmDeleteBtn"
          onclick="deleteAccount()"
          disabled
        >
          Delete My Account
        </button>
        <button
          class="btn btn-secondary"
          onclick="hideDeleteConfirmation()"
          style="margin-left: 10px"
        >
          Cancel
        </button>
      </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="config/firebase-config.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        updatePassword,
        reauthenticateWithCredential,
        EmailAuthProvider,
        sendEmailVerification,
        deleteUser,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

      // Initialize Firebase
      if (!window.firebaseConfig) {
        console.error("Firebase configuration not loaded!");
        document.body.innerHTML =
          '<div style="text-align: center; padding: 50px;"><h2>Configuration Error</h2><p>Please contact support.</p></div>';
      }

      const app = initializeApp(window.firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let currentUser = null;
      let userSettings = {};

      // Check authentication and load user data
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          await loadUserProfile();
          showAuthElements();
        } else {
          // Redirect to sign in if not authenticated
          window.location.href =
            "signin.html?redirect=" + encodeURIComponent(window.location.href);
        }
      });

      // Show authenticated elements
      function showAuthElements() {
        const adminLinks = document.querySelectorAll('a[href="admin.html"]');
        const profileLinks = document.querySelectorAll(
          'a[href="profile.html"]'
        );
        const signOutBtns = document.querySelectorAll(".sign-out-btn");

        // Always show profile link for authenticated users
        profileLinks.forEach((link) => (link.style.display = "block"));
        signOutBtns.forEach((btn) => (btn.style.display = "block"));

        // Show admin link for admin users
        if (currentUser && isAdminUser(currentUser.email)) {
          adminLinks.forEach((link) => (link.style.display = "block"));
        }
      }

      // Check if user is admin
      function isAdminUser(email) {
        const adminEmails = [
          "admin@redboxsoftware.com",
          "grayson@redboxsoftware.com",
        ];
        return adminEmails.includes(email);
      }

      // Load user profile data
      async function loadUserProfile() {
        try {
          // Update profile header
          const displayName = currentUser.displayName || "User";
          const email = currentUser.email;
          const initials = displayName
            .split(" ")
            .map((n) => n[0])
            .join("")
            .toUpperCase();

          document.getElementById("profileName").textContent = displayName;
          document.getElementById("profileEmail").textContent = email;
          document.getElementById("avatarInitials").textContent = initials;

          // Set avatar image if available
          if (currentUser.photoURL) {
            document.getElementById(
              "profileAvatar"
            ).innerHTML = `<img src="${currentUser.photoURL}" alt="Profile Picture">`;
          }

          // Load user data from Firestore
          const userDoc = await getDoc(doc(db, "users", currentUser.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            populateForm(userData);
            userSettings = userData.settings || {};
          }

          // Update account info
          document.getElementById("accountCreated").textContent = formatDate(
            currentUser.metadata.creationTime
          );
          document.getElementById("lastSignIn").textContent = formatDate(
            currentUser.metadata.lastSignInTime
          );
          document.getElementById("emailVerified").textContent =
            currentUser.emailVerified ? "Yes" : "No";

          if (!currentUser.emailVerified) {
            document.getElementById("verifyEmailBtn").style.display =
              "inline-block";
          }
        } catch (error) {
          console.error("Error loading user profile:", error);
          showMessage(
            "Error loading profile data.",
            "error",
            "personalMessageContainer"
          );
        }
      }

      // Populate form with user data
      function populateForm(userData) {
        const fields = [
          "firstName",
          "lastName",
          "phone",
          "company",
          "bio",
          "address",
          "city",
          "state",
          "zipCode",
          "country",
        ];
        fields.forEach((field) => {
          const element = document.getElementById(field);
          if (element && userData[field]) {
            element.value = userData[field];
          }
        });

        // Populate preferences
        if (userData.preferences) {
          const prefs = userData.preferences;
          if (prefs.theme) document.getElementById("theme").value = prefs.theme;
          if (prefs.language)
            document.getElementById("language").value = prefs.language;
          if (prefs.timezone)
            document.getElementById("timezone").value = prefs.timezone;
        }

        // Populate settings toggles
        if (userData.settings) {
          updateToggleStates(userData.settings);
        }
      }

      // Update toggle states
      function updateToggleStates(settings) {
        const toggles = {
          sms: settings.smsAuth || false,
          email: settings.emailAuth !== false, // default true
          loginNotify: settings.loginNotifications !== false, // default true
          emailNotif: settings.emailNotifications !== false, // default true
          marketing: settings.marketingEmails || false,
          docReminders: settings.documentReminders !== false, // default true
        };

        Object.entries(toggles).forEach(([key, value]) => {
          const toggle = document.getElementById(key + "Toggle");
          if (toggle) {
            toggle.classList.toggle("active", value);
          }
        });
      }

      // Handle personal info form submission
      document
        .getElementById("personalInfoForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await savePersonalInfo();
        });

      // Save personal information
      async function savePersonalInfo() {
        const saveBtn = document.getElementById("savePersonalBtn");
        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";
        showLoading();

        try {
          const formData = new FormData(
            document.getElementById("personalInfoForm")
          );
          const userData = {};

          formData.forEach((value, key) => {
            if (value.trim()) {
              userData[key] = value.trim();
            }
          });

          userData.updatedAt = new Date().toISOString();

          await setDoc(doc(db, "users", currentUser.uid), userData, {
            merge: true,
          });

          showMessage(
            "Profile updated successfully!",
            "success",
            "personalMessageContainer"
          );
        } catch (error) {
          console.error("Error saving profile:", error);
          showMessage(
            "Error saving profile. Please try again.",
            "error",
            "personalMessageContainer"
          );
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = "Save Changes";
          hideLoading();
        }
      }

      // Handle password change
      document
        .getElementById("changePasswordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await changePassword();
        });

      // Password validation
      document.getElementById("newPassword").addEventListener("input", (e) => {
        validatePassword(e.target.value);
      });

      function validatePassword(password) {
        const requirements = {
          lengthReq: password.length >= 8,
          upperReq: /[A-Z]/.test(password),
          lowerReq: /[a-z]/.test(password),
          numberReq: /\d/.test(password),
        };

        Object.entries(requirements).forEach(([id, valid]) => {
          const element = document.getElementById(id);
          element.classList.toggle("valid", valid);
          element.classList.toggle("invalid", !valid);
        });

        return Object.values(requirements).every(Boolean);
      }

      // Change password
      async function changePassword() {
        const currentPassword =
          document.getElementById("currentPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;
        const changeBtn = document.getElementById("changePasswordBtn");

        if (!validatePassword(newPassword)) {
          showMessage(
            "Password does not meet requirements.",
            "error",
            "securityMessageContainer"
          );
          return;
        }

        if (newPassword !== confirmPassword) {
          showMessage(
            "New passwords do not match.",
            "error",
            "securityMessageContainer"
          );
          return;
        }

        changeBtn.disabled = true;
        changeBtn.textContent = "Changing...";
        showLoading();

        try {
          // Reauthenticate user
          const credential = EmailAuthProvider.credential(
            currentUser.email,
            currentPassword
          );
          await reauthenticateWithCredential(currentUser, credential);

          // Update password
          await updatePassword(currentUser, newPassword);

          document.getElementById("changePasswordForm").reset();
          showMessage(
            "Password changed successfully!",
            "success",
            "securityMessageContainer"
          );
        } catch (error) {
          console.error("Error changing password:", error);
          let errorMessage = "Error changing password. Please try again.";

          if (error.code === "auth/wrong-password") {
            errorMessage = "Current password is incorrect.";
          } else if (error.code === "auth/weak-password") {
            errorMessage = "New password is too weak.";
          }

          showMessage(errorMessage, "error", "securityMessageContainer");
        } finally {
          changeBtn.disabled = false;
          changeBtn.textContent = "Change Password";
          hideLoading();
        }
      }

      // Toggle settings
      window.toggleSetting = function (settingName) {
        const toggle = document.getElementById(settingName + "Toggle");
        toggle.classList.toggle("active");

        const isActive = toggle.classList.contains("active");
        userSettings[settingName] = isActive;
      };

      // Save preferences
      window.savePreferences = async function () {
        showLoading();

        try {
          const preferences = {
            theme: document.getElementById("theme").value,
            language: document.getElementById("language").value,
            timezone: document.getElementById("timezone").value,
          };

          const settingsData = {
            smsAuth: document
              .getElementById("smsToggle")
              .classList.contains("active"),
            emailAuth: document
              .getElementById("emailToggle")
              .classList.contains("active"),
            loginNotifications: document
              .getElementById("loginNotifyToggle")
              .classList.contains("active"),
            emailNotifications: document
              .getElementById("emailNotifToggle")
              .classList.contains("active"),
            marketingEmails: document
              .getElementById("marketingToggle")
              .classList.contains("active"),
            documentReminders: document
              .getElementById("docRemindersToggle")
              .classList.contains("active"),
          };

          await updateDoc(doc(db, "users", currentUser.uid), {
            preferences: preferences,
            settings: settingsData,
            updatedAt: new Date().toISOString(),
          });

          showMessage(
            "Preferences saved successfully!",
            "success",
            "preferencesMessageContainer"
          );
        } catch (error) {
          console.error("Error saving preferences:", error);
          showMessage(
            "Error saving preferences. Please try again.",
            "error",
            "preferencesMessageContainer"
          );
        } finally {
          hideLoading();
        }
      };

      // Send email verification
      window.sendEmailVerification = async function () {
        const verifyBtn = document.getElementById("verifyEmailBtn");
        verifyBtn.disabled = true;
        verifyBtn.textContent = "Sending...";

        try {
          await sendEmailVerification(currentUser);
          showMessage(
            "Verification email sent! Check your inbox.",
            "success",
            "accountMessageContainer"
          );
        } catch (error) {
          console.error("Error sending verification email:", error);
          showMessage(
            "Error sending verification email. Please try again.",
            "error",
            "accountMessageContainer"
          );
        } finally {
          verifyBtn.disabled = false;
          verifyBtn.textContent = "Verify Email";
        }
      };

      // Download user data
      window.downloadUserData = async function () {
        showLoading();

        try {
          const userDoc = await getDoc(doc(db, "users", currentUser.uid));
          const userData = {
            uid: currentUser.uid,
            email: currentUser.email,
            displayName: currentUser.displayName,
            emailVerified: currentUser.emailVerified,
            creationTime: currentUser.metadata.creationTime,
            lastSignInTime: currentUser.metadata.lastSignInTime,
            ...userDoc.data(),
          };

          const dataStr = JSON.stringify(userData, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });

          const link = document.createElement("a");
          link.href = URL.createObjectURL(dataBlob);
          link.download = `rbs-user-data-${
            new Date().toISOString().split("T")[0]
          }.json`;
          link.click();

          showMessage(
            "User data downloaded successfully!",
            "success",
            "accountMessageContainer"
          );
        } catch (error) {
          console.error("Error downloading user data:", error);
          showMessage(
            "Error downloading user data. Please try again.",
            "error",
            "accountMessageContainer"
          );
        } finally {
          hideLoading();
        }
      };

      // Delete account confirmation
      window.showDeleteConfirmation = function () {
        document.getElementById("deleteModal").classList.add("show");

        // Enable/disable delete button based on inputs
        const passwordInput = document.getElementById("deletePassword");
        const confirmationInput = document.getElementById("deleteConfirmation");
        const deleteBtn = document.getElementById("confirmDeleteBtn");

        function checkInputs() {
          const hasPassword = passwordInput.value.length > 0;
          const hasConfirmation = confirmationInput.value === "DELETE";
          deleteBtn.disabled = !(hasPassword && hasConfirmation);
        }

        passwordInput.addEventListener("input", checkInputs);
        confirmationInput.addEventListener("input", checkInputs);
      };

      window.hideDeleteConfirmation = function () {
        document.getElementById("deleteModal").classList.remove("show");
        document.getElementById("deletePassword").value = "";
        document.getElementById("deleteConfirmation").value = "";
      };

      // Delete account
      window.deleteAccount = async function () {
        const password = document.getElementById("deletePassword").value;
        const confirmation =
          document.getElementById("deleteConfirmation").value;

        if (confirmation !== "DELETE") {
          alert('Please type "DELETE" to confirm account deletion.');
          return;
        }

        const deleteBtn = document.getElementById("confirmDeleteBtn");
        deleteBtn.disabled = true;
        deleteBtn.textContent = "Deleting...";
        showLoading();

        try {
          // Reauthenticate user
          const credential = EmailAuthProvider.credential(
            currentUser.email,
            password
          );
          await reauthenticateWithCredential(currentUser, credential);

          // Delete user data from Firestore
          await setDoc(doc(db, "users", currentUser.uid), {
            deleted: true,
            deletedAt: new Date().toISOString(),
          });

          // Delete user account
          await deleteUser(currentUser);

          alert("Your account has been deleted successfully.");
          window.location.href = "index.html";
        } catch (error) {
          console.error("Error deleting account:", error);
          let errorMessage = "Error deleting account. Please try again.";

          if (error.code === "auth/wrong-password") {
            errorMessage = "Password is incorrect.";
          }

          alert(errorMessage);
        } finally {
          deleteBtn.disabled = false;
          deleteBtn.textContent = "Delete My Account";
          hideLoading();
          hideDeleteConfirmation();
        }
      };

      // Tab switching
      window.switchTab = function (tabName) {
        // Remove active class from all tabs and content
        document
          .querySelectorAll(".tab-button")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        // Add active class to clicked tab and corresponding content
        event.target.classList.add("active");
        document.getElementById(tabName + "-tab").classList.add("active");
      };

      // Reset personal form
      window.resetPersonalForm = function () {
        if (
          confirm(
            "Are you sure you want to reset the form? All unsaved changes will be lost."
          )
        ) {
          document.getElementById("personalInfoForm").reset();
          loadUserProfile();
        }
      };

      // Sign out handler (global function)
      window.handleSignOut = async function () {
        if (confirm("Are you sure you want to sign out?")) {
          try {
            await signOut(auth);
            localStorage.removeItem("userEmail");
            window.location.href = "index.html";
          } catch (error) {
            console.error("Error signing out:", error);
            alert("Error signing out. Please try again.");
          }
        }
      };

      // Utility functions
      function showMessage(
        message,
        type = "info",
        containerId = "messageContainer"
      ) {
        const container = document.getElementById(containerId);
        if (container) {
          container.innerHTML = `<div class="message ${type}">${message}</div>`;

          if (type === "success") {
            setTimeout(() => {
              container.innerHTML = "";
            }, 3000);
          }
        }
      }

      function showLoading() {
        document.getElementById("loading").classList.add("show");
      }

      function hideLoading() {
        document.getElementById("loading").classList.remove("show");
      }

      function formatDate(timestamp) {
        if (!timestamp) return "Unknown";
        return new Date(timestamp).toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }
    </script>

    <!-- Include shared navigation script -->
    <script src="scripts/script.js" type="module"></script>
  </body>
</html>
