<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Document - RBS</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" href="./Images/RBS Favicon.ico" type="image/x-icon" />
    <style>
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .document-header {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
      }

      .document-title {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin-bottom: 10px;
      }

      .document-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .meta-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
      }

      .meta-label {
        font-weight: 600;
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
      }

      .meta-value {
        font-size: 16px;
        color: #333;
      }

      .document-status {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .status-partial {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .signers-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
      }

      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
      }

      .signers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .signer-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        position: relative;
      }

      .signer-card.current-user {
        border-color: #007bff;
        background: #f8f9ff;
      }

      .signer-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .signer-email {
        color: #666;
        margin-bottom: 10px;
      }

      .signer-role {
        font-size: 14px;
        color: #888;
        margin-bottom: 15px;
      }

      .signer-status {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .signer-pending {
        background: #fff3cd;
        color: #856404;
      }

      .signer-completed {
        background: #d4edda;
        color: #155724;
      }

      .signature-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
      }

      .signature-canvas-container {
        border: 2px solid #ddd;
        border-radius: 8px;
        margin: 20px 0;
        background: #f9f9f9;
      }

      .signature-canvas {
        border-radius: 6px;
        display: block;
        margin: 0 auto;
      }

      .signature-controls {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn:hover {
        background: #0056b3;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .btn-success {
        background: #28a745;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-danger {
        background: #dc3545;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .message {
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .message.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .message.warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .loading {
        text-align: center;
        padding: 60px;
        color: #666;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .text-signature-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        font-family: "Brush Script MT", cursive;
        margin: 10px 0;
      }

      .signature-type-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
      }

      .signature-tab {
        padding: 12px 24px;
        cursor: pointer;
        background: none;
        border: none;
        font-size: 16px;
        color: #666;
        transition: all 0.3s ease;
      }

      .signature-tab.active {
        color: #007bff;
        border-bottom: 2px solid #007bff;
      }

      .signature-content {
        display: none;
      }

      .signature-content.active {
        display: block;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .document-meta {
          grid-template-columns: 1fr;
        }

        .signers-grid {
          grid-template-columns: 1fr;
        }

        .signature-controls {
          flex-direction: column;
        }

        .signature-canvas {
          width: 100% !important;
          height: 150px !important;
        }

        .pdf-toolbar {
          flex-direction: column;
          gap: 10px;
          align-items: stretch;
        }

        .pdf-toolbar > div {
          display: flex;
          justify-content: center;
          flex-wrap: wrap;
          gap: 10px;
        }

        .pdf-container {
          min-height: 400px;
        }

        .pdf-canvas-container {
          padding: 10px;
          min-height: 300px;
        }

        .zoom-controls {
          justify-content: center;
        }
      }

      .auth-section {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      }

      .completion-banner {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 30px;
      }

      .completion-banner h2 {
        margin: 0 0 10px 0;
        font-size: 24px;
      }

      .completion-banner p {
        margin: 0;
        font-size: 16px;
        opacity: 0.9;
      }

      .pdf-viewer-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
      }

      .pdf-container {
        border: 2px solid #ddd;
        border-radius: 8px;
        background: #f5f5f5;
        min-height: 600px;
        position: relative;
        overflow: hidden;
      }

      .pdf-toolbar {
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .pdf-toolbar button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s ease;
      }

      .pdf-toolbar button:hover {
        background: #0056b3;
      }

      .pdf-toolbar button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .pdf-page-info {
        font-size: 14px;
        color: #666;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .pdf-canvas-container {
        text-align: center;
        padding: 20px;
        min-height: 500px;
        overflow: auto;
      }

      .pdf-canvas {
        border: 1px solid #ccc;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        max-width: 100%;
        height: auto;
      }

      .pdf-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 400px;
        color: #666;
      }

      .pdf-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 400px;
        color: #dc3545;
        text-align: center;
      }

      .zoom-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .zoom-input {
        width: 60px;
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html">
        <div class="logo">
          <img
            id="logo"
            src="./Images/RBS Logo main.svg"
            alt="RBS Logo. It's a box that's red"
          />
        </div>
      </a>
      <div class="burger">
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
      </div>

      <div id="webNav">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ▼</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>

          <br />
          <br />
          <br />
        </div>
      </div>
      <div class="dropdown-content">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ▼</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>
        </div>
      </div>
      <div id="shadow"></div>
    </nav>

    <div class="container">
      <!-- Loading Section -->
      <div id="loadingSection" class="loading">
        <div class="spinner"></div>
        <p>Loading document...</p>
      </div>

      <!-- Authentication Section -->
      <div id="authSection" class="auth-section" style="display: none">
        <div class="message error">Please sign in to view this document.</div>
        <a href="signin.html" class="btn">Sign In</a>
      </div>

      <!-- Main Content -->
      <div id="mainContent" style="display: none">
        <!-- Completion Banner -->
        <div
          id="completionBanner"
          class="completion-banner"
          style="display: none"
        >
          <h2>🎉 Document Completed!</h2>
          <p>All signatures have been collected successfully.</p>
        </div>

        <!-- Document Header -->
        <div class="document-header">
          <div class="document-title" id="documentTitle"></div>
          <div class="document-meta">
            <div class="meta-item">
              <div class="meta-label">Status</div>
              <div class="meta-value">
                <span id="documentStatus" class="document-status"></span>
              </div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Created By</div>
              <div class="meta-value" id="documentCreator"></div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Created Date</div>
              <div class="meta-value" id="documentDate"></div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Progress</div>
              <div class="meta-value" id="documentProgress"></div>
            </div>
          </div>
          <div
            id="documentDescription"
            style="margin-top: 20px; color: #666"
          ></div>
        </div>

        <!-- Signers Section -->
        <div class="signers-section">
          <h2 class="section-title">👥 Signers</h2>
          <div id="signersGrid" class="signers-grid"></div>
        </div>

        <!-- PDF Viewer Section -->
        <div
          id="pdfViewerSection"
          class="pdf-viewer-section"
          style="display: none"
        >
          <h2 class="section-title">📄 Document Preview</h2>

          <div class="pdf-container">
            <div class="pdf-toolbar">
              <button id="prevPageBtn" onclick="changePage(-1)">
                ◀ Previous
              </button>
              <button id="nextPageBtn" onclick="changePage(1)">Next ▶</button>

              <div class="pdf-page-info">
                <span>Page:</span>
                <input
                  type="number"
                  id="pageInput"
                  class="zoom-input"
                  min="1"
                  onchange="goToPage(this.value)"
                />
                <span>of <span id="totalPages">-</span></span>
              </div>

              <div class="zoom-controls">
                <button onclick="zoomOut()">🔍-</button>
                <input
                  type="number"
                  id="zoomInput"
                  class="zoom-input"
                  value="100"
                  min="25"
                  max="300"
                  step="25"
                  onchange="setZoom(this.value)"
                />
                <span>%</span>
                <button onclick="zoomIn()">🔍+</button>
                <button onclick="fitToWidth()">Fit Width</button>
              </div>

              <button onclick="downloadPdf()" class="btn-secondary">
                💾 Download
              </button>
            </div>

            <div id="pdfCanvasContainer" class="pdf-canvas-container">
              <div id="pdfLoading" class="pdf-loading">
                <div class="spinner"></div>
                <p>Loading PDF...</p>
              </div>

              <div id="pdfError" class="pdf-error" style="display: none">
                <p>❌ Failed to load PDF</p>
                <button onclick="loadPdfViewer()" class="btn">Try Again</button>
              </div>

              <canvas
                id="pdfCanvas"
                class="pdf-canvas"
                style="display: none"
              ></canvas>
            </div>
          </div>
        </div>

        <!-- Signature Section (only shown if user can sign) -->
        <div
          id="signatureSection"
          class="signature-section"
          style="display: none"
        >
          <h2 class="section-title">✍️ Your Signature</h2>

          <div class="signature-type-tabs">
            <button
              class="signature-tab active"
              onclick="switchSignatureTab('draw')"
            >
              ✏️ Draw Signature
            </button>
            <button class="signature-tab" onclick="switchSignatureTab('type')">
              ⌨️ Type Signature
            </button>
          </div>

          <!-- Draw Signature -->
          <div id="drawSignature" class="signature-content active">
            <div class="signature-canvas-container">
              <canvas
                id="signatureCanvas"
                class="signature-canvas"
                width="600"
                height="200"
              ></canvas>
            </div>
            <div class="signature-controls">
              <button onclick="clearSignature()" class="btn btn-secondary">
                🗑️ Clear
              </button>
              <button
                onclick="submitSignature('image')"
                class="btn btn-success"
              >
                ✅ Sign Document
              </button>
            </div>
          </div>

          <!-- Type Signature -->
          <div id="typeSignature" class="signature-content">
            <input
              type="text"
              id="textSignatureInput"
              class="text-signature-input"
              placeholder="Type your full name here..."
              maxlength="100"
            />
            <div class="signature-controls">
              <button onclick="submitSignature('text')" class="btn btn-success">
                ✅ Sign with Typed Name
              </button>
            </div>
          </div>

          <div id="signatureResult"></div>
        </div>

        <!-- Actions Section -->
        <div class="signature-section">
          <h2 class="section-title">📋 Actions</h2>
          <div class="signature-controls">
            <button onclick="goBack()" class="btn btn-secondary">← Back</button>
            <button
              onclick="downloadPdf()"
              class="btn"
              id="downloadBtn"
              style="display: none"
            >
              📥 Download Signed Document
            </button>
          </div>
        </div>
      </div>

      <!-- Error Section -->
      <div id="errorSection" style="display: none">
        <div class="message error" id="errorMessage"></div>
        <button onclick="goBack()" class="btn btn-secondary">← Back</button>
      </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="config/firebase-config.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFunctions } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";
      import { getStorage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const functions = getFunctions(app, "us-central1"); // Specify region
      const storage = getStorage(app);
      const firestore = getFirestore(app);

      // Make Firebase available globally
      window.firebase = {
        app,
        auth,
        functions,
        storage,
        firestore,
      };

      // Initialize custom document client
      // Wait for the CustomDocumentClient to be available
      const initClient = () => {
        if (window.CustomDocumentClient && window.firebase) {
          window.customDocumentClient = new CustomDocumentClient(
            window.firebase
          );
          console.log("CustomDocumentClient initialized successfully");
        } else {
          console.log("Waiting for CustomDocumentClient and Firebase...");
          setTimeout(initClient, 100);
        }
      };
      initClient();

      // Global variables
      window.currentDocument = null;
      window.currentUser = null;
      window.signaturePad = null;
      window.pdfDoc = null;
      window.currentPage = 1;
      window.currentZoom = 1.0;
      window.pdfData = null;

      // Load document when page loads
      onAuthStateChanged(auth, async (user) => {
        window.currentUser = user;
        await loadDocument();
      });
    </script>

    <!-- Custom Document Client -->
    <script src="scripts/custom-document-client.js"></script>

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      // Configure PDF.js worker
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>

    <!-- Page Scripts -->
    <script>
      async function loadDocument() {
        const urlParams = new URLSearchParams(window.location.search);
        const documentId = urlParams.get("id");
        const accessToken = urlParams.get("token");

        if (!documentId) {
          showError("Document ID is required.");
          return;
        }

        // Check if customDocumentClient is available
        if (!window.customDocumentClient) {
          showError(
            "Document client not initialized. Please refresh the page and try again."
          );
          return;
        }

        try {
          const result = await window.customDocumentClient.getDocument(
            documentId,
            accessToken
          );
          window.currentDocument = result.document;

          displayDocument(result.document);
        } catch (error) {
          console.error("Error loading document:", error);

          if (
            error.message.includes("Authentication required") &&
            !window.currentUser
          ) {
            document.getElementById("loadingSection").style.display = "none";
            document.getElementById("authSection").style.display = "block";
          } else {
            showError(error.message);
          }
        }
      }

      function displayDocument(docData) {
        document.getElementById("loadingSection").style.display = "none";
        document.getElementById("mainContent").style.display = "block";

        // Show completion banner if document is completed
        if (docData.status === "completed") {
          document.getElementById("completionBanner").style.display = "block";
          document.getElementById("downloadBtn").style.display = "inline-block";
        }

        // Document header
        document.getElementById("documentTitle").textContent = docData.title;
        document.getElementById(
          "documentCreator"
        ).textContent = `${docData.createdBy} (${docData.createdByEmail})`;
        document.getElementById("documentDate").textContent = new Date(
          docData.createdAt.seconds * 1000
        ).toLocaleDateString();

        const completedSigners = docData.signers.filter(
          (s) => s.status === "completed"
        ).length;
        document.getElementById(
          "documentProgress"
        ).textContent = `${completedSigners}/${docData.signers.length} signed`;

        const statusElement = document.getElementById("documentStatus");
        statusElement.textContent = docData.status;
        statusElement.className = `document-status status-${docData.status}`;

        if (docData.description) {
          document.getElementById("documentDescription").textContent =
            docData.description;
        }

        // Display signers
        displaySigners(docData.signers, docData.currentSigner);

        // Show PDF viewer
        document.getElementById("pdfViewerSection").style.display = "block";
        loadPdfViewer();

        // Show signature section if user can sign
        if (docData.currentSigner && docData.currentSigner.canSign) {
          document.getElementById("signatureSection").style.display = "block";
          // Delay signature canvas initialization to ensure client is ready
          setTimeout(() => {
            initializeSignatureCanvas();
          }, 500);
        }
      }

      function displaySigners(signers, currentSigner) {
        const grid = document.getElementById("signersGrid");
        grid.innerHTML = "";

        signers.forEach((signer) => {
          const isCurrentUser = currentSigner && signer.id === currentSigner.id;

          const signerCard = document.createElement("div");
          signerCard.className = `signer-card ${
            isCurrentUser ? "current-user" : ""
          }`;

          let statusInfo = "";
          if (signer.status === "completed" && signer.signedAt) {
            statusInfo = `<div style="margin-top: 10px; font-size: 12px; color: #666;">
              Signed: ${new Date(
                signer.signedAt.seconds * 1000
              ).toLocaleString()}
            </div>`;
          }

          signerCard.innerHTML = `
            <div class="signer-name">${signer.name}</div>
            <div class="signer-email">${signer.email}</div>
            <div class="signer-role">${signer.role}</div>
            <div class="signer-status signer-${signer.status}">${
            signer.status
          }</div>
            ${statusInfo}
            ${
              isCurrentUser
                ? '<div style="margin-top: 10px; font-size: 12px; color: #007bff; font-weight: 600;">← This is you</div>'
                : ""
            }
          `;

          grid.appendChild(signerCard);
        });
      }

      function initializeSignatureCanvas() {
        // Wait for customDocumentClient to be available
        if (!window.customDocumentClient) {
          console.error("CustomDocumentClient not available yet");
          setTimeout(initializeSignatureCanvas, 100);
          return;
        }

        const canvasContainer = document.querySelector(
          ".signature-canvas-container"
        );
        const existingCanvas = document.getElementById("signatureCanvas");

        // Remove existing canvas if present
        if (existingCanvas) {
          existingCanvas.remove();
        }

        try {
          // Create new signature pad
          window.signaturePad =
            window.customDocumentClient.createSignatureCanvas(canvasContainer, {
              width: 600,
              height: 200,
              strokeColor: "#000",
              lineWidth: 2,
            });

          // Set the canvas ID for easier reference
          if (window.signaturePad && window.signaturePad.canvas) {
            window.signaturePad.canvas.id = "signatureCanvas";
            window.signaturePad.canvas.className = "signature-canvas";
          }

          console.log("Signature pad initialized:", window.signaturePad);
          console.log(
            "Available methods:",
            window.signaturePad ? Object.keys(window.signaturePad) : "None"
          );
        } catch (error) {
          console.error("Error initializing signature canvas:", error);
        }
      }

      function clearSignature() {
        if (window.signaturePad) {
          window.signaturePad.clear();
        }
      }

      function switchSignatureTab(type) {
        // Update tabs
        document.querySelectorAll(".signature-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        // Update content
        document.querySelectorAll(".signature-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(type + "Signature").classList.add("active");
      }

      async function submitSignature(type) {
        const resultDiv = document.getElementById("signatureResult");

        // Check if customDocumentClient is available
        if (!window.customDocumentClient) {
          resultDiv.innerHTML = `
            <div class="message error">
              <strong>Error:</strong> Document client not initialized. Please refresh the page and try again.
            </div>
          `;
          return;
        }

        try {
          let signatureData = "";
          let textSignature = "";

          if (type === "image") {
            console.log("Signature pad:", window.signaturePad);
            console.log(
              "Signature pad methods:",
              window.signaturePad
                ? Object.keys(window.signaturePad)
                : "No signature pad"
            );

            if (!window.signaturePad) {
              window.customDocumentClient.showMessage(
                "Signature pad not initialized. Please refresh the page and try again.",
                "error"
              );
              return;
            }

            if (window.signaturePad.isEmpty()) {
              window.customDocumentClient.showMessage(
                "Please provide a signature.",
                "error"
              );
              return;
            }
            signatureData = window.signaturePad.getSignatureData();
          } else if (type === "text") {
            textSignature = document
              .getElementById("textSignatureInput")
              .value.trim();
            if (!textSignature) {
              window.customDocumentClient.showMessage(
                "Please type your name.",
                "error"
              );
              return;
            }
          }

          // Show loading
          resultDiv.innerHTML =
            '<div class="message info">Submitting signature...</div>';

          const urlParams = new URLSearchParams(window.location.search);
          const accessToken = urlParams.get("token");

          const result = await window.customDocumentClient.addSignature({
            documentId: window.currentDocument.id,
            signerId: window.currentDocument.currentSigner.id,
            accessToken: accessToken,
            signatureData: signatureData,
            signatureType: type,
            textSignature: textSignature,
          });

          resultDiv.innerHTML = `
            <div class="message success">
              <strong>Signature submitted successfully!</strong><br>
              ${result.message}
            </div>
          `;

          // Hide signature section
          document.getElementById("signatureSection").style.display = "none";

          // Show completion banner if all signatures collected
          if (result.allCompleted) {
            document.getElementById("completionBanner").style.display = "block";
            document.getElementById("downloadBtn").style.display =
              "inline-block";
          }

          // Reload document to show updated status
          setTimeout(() => {
            loadDocument();
          }, 2000);
        } catch (error) {
          console.error("Error submitting signature:", error);
          resultDiv.innerHTML = `
            <div class="message error">
              <strong>Error submitting signature:</strong> ${error.message}
            </div>
          `;
        }
      }

      function goBack() {
        if (document.referrer) {
          window.history.back();
        } else {
          window.location.href = "custom-document-signing.html";
        }
      }

      function showError(message) {
        document.getElementById("loadingSection").style.display = "none";
        document.getElementById("errorMessage").textContent = message;
        document.getElementById("errorSection").style.display = "block";
      }

      // PDF Viewing Functions
      async function loadPdfViewer() {
        if (!window.customDocumentClient || !window.currentDocument) {
          console.error("Document client or current document not available");
          return;
        }

        try {
          document.getElementById("pdfLoading").style.display = "flex";
          document.getElementById("pdfError").style.display = "none";
          document.getElementById("pdfCanvas").style.display = "none";

          const urlParams = new URLSearchParams(window.location.search);
          const accessToken = urlParams.get("token");

          const result = await window.customDocumentClient.getDocumentPdf(
            window.currentDocument.id,
            accessToken
          );

          if (!result.success) {
            throw new Error(result.error || "Failed to load PDF");
          }

          // Convert base64 to array buffer
          const binaryString = atob(result.pdfData);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }

          // Store PDF data for download
          window.pdfData = bytes;

          // Load PDF with PDF.js
          const pdfDoc = await pdfjsLib.getDocument({ data: bytes }).promise;
          window.pdfDoc = pdfDoc;
          window.currentPage = 1;

          document.getElementById("totalPages").textContent = pdfDoc.numPages;
          document.getElementById("pageInput").value = 1;
          document.getElementById("pageInput").max = pdfDoc.numPages;

          // Hide loading and show canvas
          document.getElementById("pdfLoading").style.display = "none";
          document.getElementById("pdfCanvas").style.display = "block";

          // Render first page
          await renderPage(1);

          // Update navigation buttons
          updateNavigationButtons();
        } catch (error) {
          console.error("Error loading PDF:", error);
          document.getElementById("pdfLoading").style.display = "none";
          document.getElementById("pdfError").style.display = "flex";
          document
            .getElementById("pdfError")
            .querySelector(
              "p"
            ).textContent = `❌ Failed to load PDF: ${error.message}`;
        }
      }

      async function renderPage(pageNum) {
        if (!window.pdfDoc) return;

        try {
          const page = await window.pdfDoc.getPage(pageNum);
          const canvas = document.getElementById("pdfCanvas");
          const context = canvas.getContext("2d");

          // Calculate scale to fit container width
          const container = document.getElementById("pdfCanvasContainer");
          const containerWidth = container.clientWidth - 40; // Account for padding
          const viewport = page.getViewport({ scale: 1 });
          const scale = (containerWidth / viewport.width) * window.currentZoom;

          const scaledViewport = page.getViewport({ scale: scale });

          canvas.height = scaledViewport.height;
          canvas.width = scaledViewport.width;

          const renderContext = {
            canvasContext: context,
            viewport: scaledViewport,
          };

          await page.render(renderContext).promise;
          window.currentPage = pageNum;

          // Update page input
          document.getElementById("pageInput").value = pageNum;
        } catch (error) {
          console.error("Error rendering page:", error);
        }
      }

      function changePage(delta) {
        if (!window.pdfDoc) return;

        const newPage = window.currentPage + delta;
        if (newPage >= 1 && newPage <= window.pdfDoc.numPages) {
          renderPage(newPage);
          updateNavigationButtons();
        }
      }

      function goToPage(pageNum) {
        if (!window.pdfDoc) return;

        const page = parseInt(pageNum);
        if (page >= 1 && page <= window.pdfDoc.numPages) {
          renderPage(page);
          updateNavigationButtons();
        }
      }

      function updateNavigationButtons() {
        if (!window.pdfDoc) return;

        const prevBtn = document.getElementById("prevPageBtn");
        const nextBtn = document.getElementById("nextPageBtn");

        prevBtn.disabled = window.currentPage <= 1;
        nextBtn.disabled = window.currentPage >= window.pdfDoc.numPages;
      }

      function zoomIn() {
        setZoom((window.currentZoom * 100 + 25).toString());
      }

      function zoomOut() {
        setZoom((window.currentZoom * 100 - 25).toString());
      }

      function setZoom(percentage) {
        const zoom = Math.max(0.25, Math.min(3.0, parseInt(percentage) / 100));
        window.currentZoom = zoom;
        document.getElementById("zoomInput").value = Math.round(zoom * 100);

        if (window.pdfDoc) {
          renderPage(window.currentPage);
        }
      }

      function fitToWidth() {
        window.currentZoom = 1.0;
        document.getElementById("zoomInput").value = 100;

        if (window.pdfDoc) {
          renderPage(window.currentPage);
        }
      }

      function downloadPdf() {
        if (!window.pdfData || !window.currentDocument) {
          window.customDocumentClient.showMessage(
            "PDF data not available for download.",
            "error"
          );
          return;
        }

        try {
          const blob = new Blob([window.pdfData], { type: "application/pdf" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = window.currentDocument.fileName || "document.pdf";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          window.customDocumentClient.showMessage(
            "PDF downloaded successfully!",
            "success"
          );
        } catch (error) {
          console.error("Error downloading PDF:", error);
          window.customDocumentClient.showMessage(
            "Failed to download PDF: " + error.message,
            "error"
          );
        }
      }

      // Handle window resize to re-render PDF at correct size
      window.addEventListener("resize", function () {
        if (window.pdfDoc && window.currentPage) {
          setTimeout(() => renderPage(window.currentPage), 100);
        }
      });
    </script>
  </body>
</html>
