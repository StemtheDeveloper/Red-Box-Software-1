<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Document - RBS</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" href="./Images/RBS Favicon.ico" type="image/x-icon" />
    <style>
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .document-header {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
      }

      .document-title {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin-bottom: 10px;
      }

      .document-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .meta-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
      }

      .meta-label {
        font-weight: 600;
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
      }

      .meta-value {
        font-size: 16px;
        color: #333;
      }

      .document-status {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .status-partial {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .signers-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
      }

      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
      }

      .signers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .signer-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        position: relative;
      }

      .signer-card.current-user {
        border-color: #007bff;
        background: #f8f9ff;
      }

      .signer-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .signer-email {
        color: #666;
        margin-bottom: 10px;
      }

      .signer-role {
        font-size: 14px;
        color: #888;
        margin-bottom: 15px;
      }

      .signer-status {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .signer-pending {
        background: #fff3cd;
        color: #856404;
      }

      .signer-completed {
        background: #d4edda;
        color: #155724;
      }

      .signature-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
      }

      .signature-canvas-container {
        border: 2px solid #ddd;
        border-radius: 8px;
        margin: 20px 0;
        background: #f9f9f9;
      }

      .signature-canvas {
        border-radius: 6px;
        display: block;
        margin: 0 auto;
      }

      .signature-controls {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn:hover {
        background: #0056b3;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .btn-success {
        background: #28a745;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-danger {
        background: #dc3545;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .message {
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .message.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .message.warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .loading {
        text-align: center;
        padding: 60px;
        color: #666;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .text-signature-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        font-family: "Brush Script MT", cursive;
        margin: 10px 0;
      }

      .signature-type-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
      }

      .signature-tab {
        padding: 12px 24px;
        cursor: pointer;
        background: none;
        border: none;
        font-size: 16px;
        color: #666;
        transition: all 0.3s ease;
      }

      .signature-tab.active {
        color: #007bff;
        border-bottom: 2px solid #007bff;
      }

      .signature-content {
        display: none;
      }

      .signature-content.active {
        display: block;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .document-meta {
          grid-template-columns: 1fr;
        }

        .signers-grid {
          grid-template-columns: 1fr;
        }

        .signature-controls {
          flex-direction: column;
        }

        .signature-canvas {
          width: 100% !important;
          height: 150px !important;
        }
      }

      .auth-section {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      }

      .completion-banner {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 30px;
      }

      .completion-banner h2 {
        margin: 0 0 10px 0;
        font-size: 24px;
      }

      .completion-banner p {
        margin: 0;
        font-size: 16px;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html">
        <div class="logo">
          <img
            id="logo"
            src="./Images/RBS Logo main.svg"
            alt="RBS Logo. It's a box that's red"
          />
        </div>
      </a>
      <div class="burger">
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
      </div>

      <div id="webNav">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ▼</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>

          <br />
          <br />
          <br />
        </div>
      </div>
      <div class="dropdown-content">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ▼</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>
        </div>
      </div>
      <div id="shadow"></div>
    </nav>

    <div class="container">
      <!-- Loading Section -->
      <div id="loadingSection" class="loading">
        <div class="spinner"></div>
        <p>Loading document...</p>
      </div>

      <!-- Authentication Section -->
      <div id="authSection" class="auth-section" style="display: none">
        <div class="message error">Please sign in to view this document.</div>
        <a href="signin.html" class="btn">Sign In</a>
      </div>

      <!-- Main Content -->
      <div id="mainContent" style="display: none">
        <!-- Completion Banner -->
        <div
          id="completionBanner"
          class="completion-banner"
          style="display: none"
        >
          <h2>🎉 Document Completed!</h2>
          <p>All signatures have been collected successfully.</p>
        </div>

        <!-- Document Header -->
        <div class="document-header">
          <div class="document-title" id="documentTitle"></div>
          <div class="document-meta">
            <div class="meta-item">
              <div class="meta-label">Status</div>
              <div class="meta-value">
                <span id="documentStatus" class="document-status"></span>
              </div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Created By</div>
              <div class="meta-value" id="documentCreator"></div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Created Date</div>
              <div class="meta-value" id="documentDate"></div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Progress</div>
              <div class="meta-value" id="documentProgress"></div>
            </div>
          </div>
          <div
            id="documentDescription"
            style="margin-top: 20px; color: #666"
          ></div>
        </div>

        <!-- Signers Section -->
        <div class="signers-section">
          <h2 class="section-title">👥 Signers</h2>
          <div id="signersGrid" class="signers-grid"></div>
        </div>

        <!-- Signature Section (only shown if user can sign) -->
        <div
          id="signatureSection"
          class="signature-section"
          style="display: none"
        >
          <h2 class="section-title">✍️ Your Signature</h2>

          <div class="signature-type-tabs">
            <button
              class="signature-tab active"
              onclick="switchSignatureTab('draw')"
            >
              ✏️ Draw Signature
            </button>
            <button class="signature-tab" onclick="switchSignatureTab('type')">
              ⌨️ Type Signature
            </button>
          </div>

          <!-- Draw Signature -->
          <div id="drawSignature" class="signature-content active">
            <div class="signature-canvas-container">
              <canvas
                id="signatureCanvas"
                class="signature-canvas"
                width="600"
                height="200"
              ></canvas>
            </div>
            <div class="signature-controls">
              <button onclick="clearSignature()" class="btn btn-secondary">
                🗑️ Clear
              </button>
              <button
                onclick="submitSignature('image')"
                class="btn btn-success"
              >
                ✅ Sign Document
              </button>
            </div>
          </div>

          <!-- Type Signature -->
          <div id="typeSignature" class="signature-content">
            <input
              type="text"
              id="textSignatureInput"
              class="text-signature-input"
              placeholder="Type your full name here..."
              maxlength="100"
            />
            <div class="signature-controls">
              <button onclick="submitSignature('text')" class="btn btn-success">
                ✅ Sign with Typed Name
              </button>
            </div>
          </div>

          <div id="signatureResult"></div>
        </div>

        <!-- Actions Section -->
        <div class="signature-section">
          <h2 class="section-title">📋 Actions</h2>
          <div class="signature-controls">
            <button onclick="goBack()" class="btn btn-secondary">← Back</button>
            <button
              onclick="downloadDocument()"
              class="btn"
              id="downloadBtn"
              style="display: none"
            >
              📥 Download Signed Document
            </button>
          </div>
        </div>
      </div>

      <!-- Error Section -->
      <div id="errorSection" style="display: none">
        <div class="message error" id="errorMessage"></div>
        <button onclick="goBack()" class="btn btn-secondary">← Back</button>
      </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="config/firebase-config.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFunctions } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";
      import { getStorage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const functions = getFunctions(app, "us-central1"); // Specify region
      const storage = getStorage(app);
      const firestore = getFirestore(app);

      // Make Firebase available globally
      window.firebase = {
        app,
        auth,
        functions,
        storage,
        firestore,
      };

      // Initialize custom document client
      // Wait for the CustomDocumentClient to be available
      const initClient = () => {
        if (window.CustomDocumentClient) {
          window.customDocumentClient = new CustomDocumentClient(
            window.firebase
          );
        } else {
          setTimeout(initClient, 100);
        }
      };
      initClient();

      // Global variables
      window.currentDocument = null;
      window.currentUser = null;
      window.signaturePad = null;

      // Load document when page loads
      onAuthStateChanged(auth, async (user) => {
        window.currentUser = user;
        await loadDocument();
      });
    </script>

    <!-- Custom Document Client -->
    <script src="scripts/custom-document-client.js"></script>

    <!-- Page Scripts -->
    <script>
      async function loadDocument() {
        const urlParams = new URLSearchParams(window.location.search);
        const documentId = urlParams.get("id");
        const accessToken = urlParams.get("token");

        if (!documentId) {
          showError("Document ID is required.");
          return;
        }

        // Check if customDocumentClient is available
        if (!window.customDocumentClient) {
          showError(
            "Document client not initialized. Please refresh the page and try again."
          );
          return;
        }

        try {
          const result = await window.customDocumentClient.getDocument(
            documentId,
            accessToken
          );
          window.currentDocument = result.document;

          displayDocument(result.document);
        } catch (error) {
          console.error("Error loading document:", error);

          if (
            error.message.includes("Authentication required") &&
            !window.currentUser
          ) {
            document.getElementById("loadingSection").style.display = "none";
            document.getElementById("authSection").style.display = "block";
          } else {
            showError(error.message);
          }
        }
      }

      function displayDocument(docData) {
        document.getElementById("loadingSection").style.display = "none";
        document.getElementById("mainContent").style.display = "block";

        // Show completion banner if document is completed
        if (docData.status === "completed") {
          document.getElementById("completionBanner").style.display = "block";
          document.getElementById("downloadBtn").style.display = "inline-block";
        }

        // Document header
        document.getElementById("documentTitle").textContent = docData.title;
        document.getElementById(
          "documentCreator"
        ).textContent = `${docData.createdBy} (${docData.createdByEmail})`;
        document.getElementById("documentDate").textContent = new Date(
          docData.createdAt.seconds * 1000
        ).toLocaleDateString();

        const completedSigners = docData.signers.filter(
          (s) => s.status === "completed"
        ).length;
        document.getElementById(
          "documentProgress"
        ).textContent = `${completedSigners}/${docData.signers.length} signed`;

        const statusElement = document.getElementById("documentStatus");
        statusElement.textContent = docData.status;
        statusElement.className = `document-status status-${docData.status}`;

        if (docData.description) {
          document.getElementById("documentDescription").textContent =
            docData.description;
        }

        // Display signers
        displaySigners(docData.signers, docData.currentSigner);

        // Show signature section if user can sign
        if (docData.currentSigner && docData.currentSigner.canSign) {
          document.getElementById("signatureSection").style.display = "block";
          initializeSignatureCanvas();
        }
      }

      function displaySigners(signers, currentSigner) {
        const grid = document.getElementById("signersGrid");
        grid.innerHTML = "";

        signers.forEach((signer) => {
          const isCurrentUser = currentSigner && signer.id === currentSigner.id;

          const signerCard = document.createElement("div");
          signerCard.className = `signer-card ${
            isCurrentUser ? "current-user" : ""
          }`;

          let statusInfo = "";
          if (signer.status === "completed" && signer.signedAt) {
            statusInfo = `<div style="margin-top: 10px; font-size: 12px; color: #666;">
              Signed: ${new Date(
                signer.signedAt.seconds * 1000
              ).toLocaleString()}
            </div>`;
          }

          signerCard.innerHTML = `
            <div class="signer-name">${signer.name}</div>
            <div class="signer-email">${signer.email}</div>
            <div class="signer-role">${signer.role}</div>
            <div class="signer-status signer-${signer.status}">${
            signer.status
          }</div>
            ${statusInfo}
            ${
              isCurrentUser
                ? '<div style="margin-top: 10px; font-size: 12px; color: #007bff; font-weight: 600;">← This is you</div>'
                : ""
            }
          `;

          grid.appendChild(signerCard);
        });
      }

      function initializeSignatureCanvas() {
        const canvas = document.getElementById("signatureCanvas");
        window.signaturePad = window.customDocumentClient.createSignatureCanvas(
          canvas.parentNode,
          {
            width: 600,
            height: 200,
            strokeColor: "#000",
            lineWidth: 2,
          }
        );

        // Remove the old canvas and use the new one
        canvas.remove();
      }

      function clearSignature() {
        if (window.signaturePad) {
          window.signaturePad.clear();
        }
      }

      function switchSignatureTab(type) {
        // Update tabs
        document.querySelectorAll(".signature-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        // Update content
        document.querySelectorAll(".signature-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(type + "Signature").classList.add("active");
      }

      async function submitSignature(type) {
        const resultDiv = document.getElementById("signatureResult");

        // Check if customDocumentClient is available
        if (!window.customDocumentClient) {
          resultDiv.innerHTML = `
            <div class="message error">
              <strong>Error:</strong> Document client not initialized. Please refresh the page and try again.
            </div>
          `;
          return;
        }

        try {
          let signatureData = "";
          let textSignature = "";

          if (type === "image") {
            if (!window.signaturePad || window.signaturePad.isEmpty()) {
              window.customDocumentClient.showMessage(
                "Please provide a signature.",
                "error"
              );
              return;
            }
            signatureData = window.signaturePad.getSignatureData();
          } else if (type === "text") {
            textSignature = document
              .getElementById("textSignatureInput")
              .value.trim();
            if (!textSignature) {
              window.customDocumentClient.showMessage(
                "Please type your name.",
                "error"
              );
              return;
            }
          }

          // Show loading
          resultDiv.innerHTML =
            '<div class="message info">Submitting signature...</div>';

          const urlParams = new URLSearchParams(window.location.search);
          const accessToken = urlParams.get("token");

          const result = await window.customDocumentClient.addSignature({
            documentId: window.currentDocument.id,
            signerId: window.currentDocument.currentSigner.id,
            accessToken: accessToken,
            signatureData: signatureData,
            signatureType: type,
            textSignature: textSignature,
          });

          resultDiv.innerHTML = `
            <div class="message success">
              <strong>Signature submitted successfully!</strong><br>
              ${result.message}
            </div>
          `;

          // Hide signature section
          document.getElementById("signatureSection").style.display = "none";

          // Show completion banner if all signatures collected
          if (result.allCompleted) {
            document.getElementById("completionBanner").style.display = "block";
            document.getElementById("downloadBtn").style.display =
              "inline-block";
          }

          // Reload document to show updated status
          setTimeout(() => {
            loadDocument();
          }, 2000);
        } catch (error) {
          console.error("Error submitting signature:", error);
          resultDiv.innerHTML = `
            <div class="message error">
              <strong>Error submitting signature:</strong> ${error.message}
            </div>
          `;
        }
      }

      function downloadDocument() {
        // This would typically download the signed PDF
        // For now, we'll show a message
        window.customDocumentClient.showMessage(
          "Download functionality will be implemented in the next phase.",
          "info"
        );
      }

      function goBack() {
        if (document.referrer) {
          window.history.back();
        } else {
          window.location.href = "custom-document-signing.html";
        }
      }

      function showError(message) {
        document.getElementById("loadingSection").style.display = "none";
        document.getElementById("errorMessage").textContent = message;
        document.getElementById("errorSection").style.display = "block";
      }
    </script>
  </body>
</html>
