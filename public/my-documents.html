<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Documents - Red Box Software</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f8f9fa;
        min-height: 100vh;
      }

      .navbar {
        background: #2c3e50;
        color: white;
        padding: 15px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .navbar .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .navbar h1 {
        font-size: 1.5em;
      }

      .navbar .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .navbar button {
        background: #34495e;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .navbar button:hover {
        background: #4a6fa5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 30px 20px;
      }

      .dashboard-header {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .dashboard-header h2 {
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .dashboard-header p {
        color: #6c757d;
        margin-bottom: 20px;
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-2px);
      }

      .btn-outline {
        background: transparent;
        color: #007bff;
        border: 2px solid #007bff;
      }

      .btn-outline:hover {
        background: #007bff;
        color: white;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-card .icon {
        font-size: 2.5em;
        margin-bottom: 15px;
      }

      .stat-card .number {
        font-size: 2em;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .stat-card .label {
        color: #6c757d;
        font-weight: 600;
      }

      .documents-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }

      .section-header {
        padding: 25px 30px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .section-header h3 {
        color: #2c3e50;
        margin: 0;
      }

      .filter-tabs {
        display: flex;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 4px;
      }

      .filter-tab {
        padding: 10px 20px;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: 6px;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s ease;
      }

      .filter-tab.active {
        background: white;
        color: #007bff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .documents-list {
        max-height: 600px;
        overflow-y: auto;
      }

      .document-item {
        padding: 20px 30px;
        border-bottom: 1px solid #f1f3f4;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.3s ease;
        cursor: pointer;
      }

      .document-item:hover {
        background: #f8f9fa;
      }

      .document-item:last-child {
        border-bottom: none;
      }

      .document-info {
        flex: 1;
      }

      .document-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
        font-size: 1.1em;
      }

      .document-meta {
        color: #6c757d;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .document-status {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-partial {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .progress-bar {
        width: 120px;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #28a745;
        transition: width 0.3s ease;
      }

      .document-actions {
        display: flex;
        gap: 10px;
      }

      .btn-sm {
        padding: 8px 16px;
        font-size: 0.9em;
        border-radius: 6px;
      }

      .btn-view {
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .btn-view:hover {
        background: #0056b3;
      }

      .empty-state {
        padding: 60px 30px;
        text-align: center;
        color: #6c757d;
      }

      .empty-state .icon {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .loading {
        padding: 40px;
        text-align: center;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .message {
        padding: 15px 20px;
        border-radius: 8px;
        margin: 20px 0;
        font-weight: 500;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      @media (max-width: 768px) {
        .container {
          padding: 15px 10px;
        }

        .dashboard-header {
          padding: 20px 15px;
        }

        .section-header {
          padding: 20px 15px;
          flex-direction: column;
          gap: 15px;
          align-items: stretch;
        }

        .filter-tabs {
          width: 100%;
        }

        .document-item {
          padding: 15px;
          flex-direction: column;
          align-items: stretch;
          gap: 15px;
        }

        .document-status {
          justify-content: space-between;
        }

        .action-buttons {
          flex-direction: column;
        }

        .btn {
          width: 100%;
          text-align: center;
        }

        .navbar .container {
          flex-direction: column;
          gap: 15px;
        }

        .navbar .user-info {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="index.html">
        <div class="logo">
          <img
            id="logo"
            src="./Images/RBS Logo main.svg"
            alt="RBS Logo. It's a box that's red"
          />
        </div>
      </a>
      <div class="burger">
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
      </div>

      <div id="webNav">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ▼</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>

          <br />
          <br />
          <br />
        </div>
      </div>
      <div class="dropdown-content">
        <div id="navBtnsCont" class="nav-links">
          <a href="index.html"><li>Home</li></a>
          <a href="projects.html"><li>Projects</li></a>
          <a href="products.html"><li>Products</li></a>
          <a href="services.html"><li>Services</li></a>
          <a href="articles.html"><li>Articles</li></a>
          <a href="about.html"><li>About</li></a>
          <a href="contact.html"><li>Contact</li></a>
          <div class="tools-dropdown">
            <li>More ▼</li>
            <div class="tools-dropdown-content">
              <a href="clip_path_editor.html">Clip Path Editor</a>
              <a href="cubic_bezier.html">Cubic Bezier</a>
              <a href="base64.html">Base64 image encoder - decoder</a>
              <a href="kanban.html">Kanban Task Manager</a>
              <a href="qr_code_generator.html">QR code generator</a>
              <a href="custom-document-signing.html">Document Signing</a>
            </div>
          </div>

          <a href="admin.html" style="display: none"><li>Admin</li></a>
          <li>
            <button
              onclick="handleSignOut()"
              class="sign-out-btn"
              style="display: none"
            >
              Sign Out
            </button>
          </li>
        </div>
      </div>
      <div id="shadow"></div>
    </nav>

    <div class="container">
      <div class="dashboard-header">
        <h2>Document Dashboard</h2>
        <p>Manage and track your document signing workflows</p>
        <div class="action-buttons">
          <a href="upload-document.html" class="btn btn-primary"
            >📤 Send New Document</a
          >
          <a href="index.html" class="btn btn-outline">🏠 Back to Home</a>
        </div>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="icon">📄</div>
          <div class="number" id="totalDocuments">-</div>
          <div class="label">Total Documents</div>
        </div>
        <div class="stat-card">
          <div class="icon">⏳</div>
          <div class="number" id="pendingDocuments">-</div>
          <div class="label">Pending Signatures</div>
        </div>
        <div class="stat-card">
          <div class="icon">✅</div>
          <div class="number" id="completedDocuments">-</div>
          <div class="label">Completed</div>
        </div>
        <div class="stat-card">
          <div class="icon">👥</div>
          <div class="number" id="documentsToSign">-</div>
          <div class="label">Awaiting My Signature</div>
        </div>
      </div>

      <div class="documents-section">
        <div class="section-header">
          <h3>Documents</h3>
          <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterDocuments('all')">
              All
            </button>
            <button class="filter-tab" onclick="filterDocuments('sent')">
              Sent by Me
            </button>
            <button class="filter-tab" onclick="filterDocuments('received')">
              Received
            </button>
            <button class="filter-tab" onclick="filterDocuments('pending')">
              Pending
            </button>
            <button class="filter-tab" onclick="filterDocuments('completed')">
              Completed
            </button>
          </div>
        </div>

        <div id="documentsContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading documents...</p>
          </div>
        </div>
      </div>

      <div id="messageContainer"></div>
    </div>

    <!-- Firebase Configuration -->
    <script src="config/firebase-config.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut as firebaseSignOut,
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-functions.js";

      // Initialize Firebase
      if (!window.firebaseConfig) {
        console.error("Firebase configuration not loaded!");
        showMessage("Configuration error. Please contact support.", "error");
      }

      const app = initializeApp(window.firebaseConfig);
      const auth = getAuth(app);
      const functions = getFunctions(app);

      let documents = [];
      let filteredDocuments = [];
      let currentFilter = "all";

      // Authentication check
      onAuthStateChanged(auth, (user) => {
        if (user) {
          document.getElementById("userEmail").textContent = user.email;
          loadDocuments();
        } else {
          window.location.href =
            "signin.html?redirect=" +
            encodeURIComponent(window.location.pathname);
        }
      });

      window.signOut = async function () {
        try {
          await firebaseSignOut(auth);
          window.location.href = "index.html";
        } catch (error) {
          console.error("Error signing out:", error);
        }
      };

      async function loadDocuments() {
        try {
          const getUserDocuments = httpsCallable(functions, "getUserDocuments");
          const result = await getUserDocuments({ limit: 100 });

          if (!result.data.success) {
            throw new Error(result.data.error);
          }

          documents = result.data.documents;
          updateStats();
          filterDocuments(currentFilter);
        } catch (error) {
          console.error("Error loading documents:", error);
          showMessage(error.message || "Failed to load documents", "error");

          document.getElementById("documentsContainer").innerHTML = `
                    <div class="empty-state">
                        <div class="icon">❌</div>
                        <h3>Error Loading Documents</h3>
                        <p>${
                          error.message || "Please try refreshing the page"
                        }</p>
                    </div>
                `;
        }
      }

      function updateStats() {
        const total = documents.length;
        const pending = documents.filter(
          (doc) => doc.status === "pending" || doc.status === "partial"
        ).length;
        const completed = documents.filter(
          (doc) => doc.status === "completed"
        ).length;
        const toSign = documents.filter(
          (doc) => !doc.isCreator && doc.signerStatus === "pending"
        ).length;

        document.getElementById("totalDocuments").textContent = total;
        document.getElementById("pendingDocuments").textContent = pending;
        document.getElementById("completedDocuments").textContent = completed;
        document.getElementById("documentsToSign").textContent = toSign;
      }

      window.filterDocuments = function (filter) {
        currentFilter = filter;

        // Update tab styling
        document.querySelectorAll(".filter-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        // Filter documents
        switch (filter) {
          case "all":
            filteredDocuments = documents;
            break;
          case "sent":
            filteredDocuments = documents.filter((doc) => doc.isCreator);
            break;
          case "received":
            filteredDocuments = documents.filter((doc) => !doc.isCreator);
            break;
          case "pending":
            filteredDocuments = documents.filter(
              (doc) => doc.status === "pending" || doc.status === "partial"
            );
            break;
          case "completed":
            filteredDocuments = documents.filter(
              (doc) => doc.status === "completed"
            );
            break;
        }

        displayDocuments();
      };

      function displayDocuments() {
        const container = document.getElementById("documentsContainer");

        if (filteredDocuments.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📄</div>
                        <h3>No Documents Found</h3>
                        <p>No documents match the current filter. Try sending your first document!</p>
                    </div>
                `;
          return;
        }

        const documentsHTML = `
                <div class="documents-list">
                    ${filteredDocuments
                      .map((doc) => createDocumentItem(doc))
                      .join("")}
                </div>
            `;

        container.innerHTML = documentsHTML;
      }

      function createDocumentItem(doc) {
        const createdDate = new Date(
          doc.createdAt.seconds * 1000
        ).toLocaleDateString();
        const progressPercent = Math.round(
          (doc.completedSigners / doc.signersCount) * 100
        );

        return `
                <div class="document-item" onclick="viewDocument('${doc.id}')">
                    <div class="document-info">
                        <div class="document-title">${doc.title}</div>
                        <div class="document-meta">
                            <span>📅 ${createdDate}</span>
                            <span>👤 ${
                              doc.isCreator
                                ? "Sent by you"
                                : `From ${doc.createdBy}`
                            }</span>
                            <span>👥 ${doc.completedSigners}/${
          doc.signersCount
        } signed</span>
                            ${
                              !doc.isCreator
                                ? `<span>📝 ${doc.role}</span>`
                                : ""
                            }
                        </div>
                    </div>
                    <div class="document-status">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <span class="status-badge status-${doc.status}">${
          doc.status
        }</span>
                        <div class="document-actions">
                            <button class="btn btn-view btn-sm" onclick="event.stopPropagation(); viewDocument('${
                              doc.id
                            }')">
                                ${
                                  doc.isCreator || doc.status === "completed"
                                    ? "View"
                                    : "Sign"
                                }
                            </button>
                        </div>
                    </div>
                </div>
            `;
      }

      window.viewDocument = function (documentId) {
        // For now, redirect to a view page - you can implement this later
        window.location.href = `view-document.html?id=${documentId}`;
      };

      function showMessage(message, type = "info") {
        const messageContainer = document.getElementById("messageContainer");
        messageContainer.innerHTML = `<div class="message ${type}">${message}</div>`;
        setTimeout(() => {
          messageContainer.innerHTML = "";
        }, 5000);
      }

      // Initial filter setup
      document.addEventListener("DOMContentLoaded", () => {
        // Set initial filter
        filterDocuments("all");
      });
    </script>
  </body>
</html>
